\section{Application to synthetic data}\label{sec:synthetic}

\subsection{Simple model test}

We have simulated a lopolithic intrusion, a funnel-shaped source \cite[]{cawthorn-2018}, with simple geometry (blue prisms in Figs \ref{fig:simple_model}b and \ref{fig:simple_results}), which extends from $z_0=0$ m to $1,600$ m along depth and satisfies most of the constraints described in subsection \ref{sec:constraints}. It is formed by $L=8$ prisms, all of them with the same number of vertices $ V = 20 $, thickness $ dz = 200 $ m and horizontal coordinates $ (x_0^k, y_0^k) = (0, 0) $ m of the origins $O^k$, $k=1,\dots,L$. The radii of all vertices are equal to each other within the same prism and decrease linearly with depth, varying from $r_j^0=1\,920$ m, at the shallowest prism, $r_j^L=800$ m, at the deepest prism, $j=1,\dots, V$. All prisms have the same total-magnetization direction with inclination $ -50^\circ $, declination $ 9^\circ $ and intensity $ m_0 = 9 $ A/m. We calculated the total-field anomaly produced by this simple model, in an area of $ 100 $ km$^2$ area, by simulating an airborne survey composed of $ 21 $ flight lines that are equally spaced $ 500 $ m apart along the y axis, at a constant vertical coordinate $ z = -150 $ m. At each line, there are $ 101 $ observation points spaced $100$ m apart along $ x $ axis. 
The main geomagnetic field direction simulated was  $ -21.5^\circ $ and  $ -18.7^\circ $ for the inclination and declination, respectively. 
The total-field anomaly is corrupted with a pseudorandom Gaussian noise having mean $ \mu_0=0 $ nT and and standard deviation $ \sigma_0 = 5 $ nT (Fig. \ref{fig:simple_model}a).


We have inverted the noise-corrupted total-field anomaly (Fig. \ref{fig:simple_model}a) produced by the simulated lopolith-like body (blue prisms in Fig. \ref{fig:simple_model}b) and obtained 36 different estimates. 
Each estimate was obtained by using six different pairs of depth to the top $ z_0 $ and total-magnetization intensity $ m_0 $.
The ranges of $ z_0 $ and $ m_0 $ are shown in Fig. \ref{fig:simple_model}c. 
Fig. \ref{fig:simple_model}d shows the RTP anomaly obtained from the noise-corrupted 
total-field anomaly (Fig. \ref{fig:simple_model}a).
Note that the RTP anomaly exhibits predominantly positive values and decays to zero.
As previously mentioned, the RTP anomaly is used to set up the initial guess. 
The blue circle in Fig. \ref{fig:simple_model}d represents the horizontal projection 
of the initial approximation $\hat{\mathbf{p}}_{(0)}$ whose shape is a vertical cylinder.
All estimates were generated by using the true values of total-magnetization inclination and declination, the same interpretation model formed by $ L = 5 $ prisms, 
each one with $ V = 20 $ vertices, and the same weights for the constraining functions: 
$\tilde{\alpha}_1 = 10^{-5}$, 
$\tilde{\alpha}_2 = 10^{-4}$, 
$\tilde{\alpha}_3 = 10^{-4}$, 
$\tilde{\alpha}_4 = 0$, 
$\tilde{\alpha}_5 = 0$, 
$\tilde{\alpha}_6 = 10^{-7}$, and 
$\tilde{\alpha}_7 = 10^{-6}$. 
In all inversions, the initial approximation $\hat{\mathbf{p}}_{(0)}$ (red prisms in Fig. \ref{fig:simple_results}b) has the same constant radii $ r^k_j = 2,000 $ m, 
$ k = 1, \dots, L $, $ j  = 1, \dots, V $, the same prism thicknesses $ dz = 350 $ m and the same origins $(x^k_0, y^k_0) = (0, 0) $ m for all prisms.

Fig. \ref{fig:simple_model}c shows the discrete mapping of the goal functional 
$ \Gamma(\mathbf{p}) $ (eq. \ref{eq:gamma}) on the plane of the total-magnetization intensity ($ m_0 $) versus depth to the top ($ z_0 $). 
The true values of depth to the top $ z_0 $ and total-magnetization intensity $ m_0 $ (represented by the red triangle in Fig. \ref{fig:simple_model}c) produces 
the smallest value of goal function  $ \Gamma(\mathbf{p}) $ (eq. \ref{eq:gamma})
that will be taken as the best estimated model.
This estimated model (red prisms in Figs \ref{fig:simple_results}c and d) 
not only fits the noise-corrupted data (Fig. \ref{fig:simple_results}a), 
but also retrieves the geometry of the true model (blue prisms in Figs \ref{fig:simple_results}b-d). 
The inset in Fig. \ref{fig:simple_results}a shows that the residuals follow a normal distribution with mean $ \mu $ and standard deviation $ \sigma $ compatible with those values used to generate the synthetic noise. 
The estimated thickness of each prism is $ dz = 298.13 $ m resulting in a depth-to-bottom estimate ($ 1,490.65$ m) very close to the true one ($ 1,600 $ m). 
These results illustrate the good performance of our method in an ideal case.


\subsection{Dipping model test}

Fig. \ref{fig:dipping_model}a shows the noise-corrupted total-field anomaly produced by an outcropping low-angle dipping volcanic duct (blue prisms in Figs \ref{fig:dipping_model}c and d) embedded in nonmagnetic host rocks. 
The simulated magnetic data are contaminated with a pseudorandom Gaussian noise having mean of $ \mu_0=0 $ nT and standard deviation of $ \sigma_0 = 5 $ nT.
We simulated airborne magnetic survey whose flight heights ranging from 0 to 720 m
(Fig. \ref{fig:dipping_model}b) and resulting in a total of 1,694 measurements.
The simulated dipping source has total-magnetization direction with inclination 
$ -50^\circ $, declination $ 9^\circ $ and intensity $ m_0 = 12 $ A/m.
The main geomagnetic field direction  has inclination of  $ -21.5^\circ $ and  declination of $ -18.7^\circ $.
To set up the simulated dipping source (blue prisms in Figs \ref{fig:dipping_model}c and d),
we used $L=8$ prisms, all of them with the same number of vertices $ V = 20 $ and thickness 
$ dz = 380 $ m. 
The horizontal coordinates of the center of the shallowest prism that composes the
simulated dipping source are $ (x_0^1, y_0^1) = (-300, 600) $ m. 
The simulated dipping source has a top  0 m deep ($z_0 = 0$) and a base 3,040 m deep.

To set up the initial guess and other variables in the inversion, we calculate the RTP anomaly (Fig. \ref{fig:dipping_rtp}a) of the noise-corrupted total-field anomaly (Fig. \ref{fig:dipping_model}a).
Fig. \ref{fig:dipping_rtp}b  shows the goal function (eq. \ref{eq:gamma}) on the plane 
$z_0 \times m_0 $ produced by 36 estimates obtained with a grid of $6 \times 6$ tentative values of depth to the top $z_0$ and total-magnetization intensity $m_0$. 

All 36 estimates were generated by using the true values of total-magnetization inclination and declination, the same interpretation model formed by $ L = 5 $ prisms, 
each one with $ V = 20 $ vertices, and the same weights for the constraining functions: 
$\tilde{\alpha}_1 = 10^{-3}$, 
$\tilde{\alpha}_2 = 10^{-3}$, 
$\tilde{\alpha}_3 = 10^{-6}$, 
$\tilde{\alpha}_4 = 0$, 
$\tilde{\alpha}_5 = 0$, 
$\tilde{\alpha}_6 = 10^{-3}$, and 
$\tilde{\alpha}_7 = 10^{-5}$. 


The optimum solution is the one that produces the smallest value of the discrete mapping 
of the goal function (Fig. \ref{fig:dipping_rtp}b). 
The white diamond in Fig. \ref{fig:dipping_rtp}b pinpoints the minimum of the goal function which is achieved when the estimated body has a top  20 m deep and a total-magnetization intensity of 12 A/m. 
Note that the depth to the top of estimated body is deeper than the true one; 
however, the total-magnetization intensity was retrieved correctly.

Fig. \ref{fig:dipping_results}a shows the magnetic-data residuals, defined as the difference
between the synthetic noise-corrupted magnetic data in Fig. \ref{fig:dipping_model}a 
and the predicted data (not shown).
Fig. \ref{fig:dipping_results}a shows the simulated dipping source (blue prisms) and 
the cylinder-like initial guess (red prisms) with  thickness $ dz = 350 $ m and 
and the same origins $(x^k_0, y^k_0) = (-200, 0) $ m for all prisms.
Note that the estimated source (red prisms in Figs.\ref{fig:dipping_results}c and d)
with $z_0 = 20$ m and $m_0 = 12$ A/m 
(pinpointed as the white diamond in Fig. \ref{fig:dipping_rtp}b)
retrieved the shape of the  simulated dipping source (blue prisms) reasonably, although
the retrieved depth to the bottom of 3,453.0 m was deeper than the true one.
The retrieved deep-bottomed dipping source is because that the depth to the top 
of estimated body has been deeper than the true one.


\subsection{Dipping model in the presence of a regional field test}

We analyze the ability of the proposed method to retrieve the geometry of the source
in a real world scenario, where the observed total-field anomaly is produced not only by 
the magnetized source but also by  a regional field. 
Here, the magnetized source to be retrieved has the same shape (blue prisms in Figs \ref{fig:dipping_model}c and d) and magnetization direction of the previous test. 
In this test, the noise-corrupted total-field anomaly to be inverted 
(Fig. \ref{fig:dipping_regional_model}a) is obtained by adding 
a  simulated regional field (Fig. \ref{fig:dipping_regional_model}b), 
represented by a first-order polynomial, 
to  a simulated residual field (Fig. \ref{fig:dipping_model}a) due to outcropping low-angle dipping volcanic duct (blue prisms in Figs \ref{fig:dipping_model}c and d). 

To remove the regional field from the original data (Fig. \ref{fig:dipping_regional_model}a),
we perform a regional-residual separation by fitting a first-order polynomial 
to the original data using the least-squares method.
Fig. \ref{fig:dipping_regional_model}c shows the residual total-field anomaly after subtracting from the original anomaly a regional total-field anomaly 
(Fig. \ref{fig:dipping_regional_model}d) obtained by a least-squares polynomial fitting. 

We invert the anomaly over the area delimited by the magenta rectangle shown in Fig. \ref{fig:dipping_regional_model}c.
This anomaly to be inverted is called residual total-field anomaly and it is shown in 
Fig. \ref{fig:dipping_regional_rtp}a.
Because we expect that this anomaly is due to the dipping model (blue prisms in Figs. \ref{fig:dipping_model}c and d), we calculate the 
differences (Fig. \ref{fig:dipping_regional_rtp}b) between the total-field anomaly produced by the dipping model (Fig.  \ref{fig:dipping_model}a) and the residual total-field anomaly 
(Fig. \ref{fig:dipping_regional_rtp}a) after a regional-residual separation using a least-squares polynomial fitting. 
Note that over the source the differences are less than 0.8$\%$ of the amplitude of the data due to the dipping model.
Fig. \ref{fig:dipping_regional_rtp}c shows the RTP anomaly of the residual total-field anomaly shown in \ref{fig:dipping_regional_rtp}a that is used to set up the 
cylinder-like initial guess.
We perform 36 inversions by seting the same control variables of the previous test.
The 36 estimates yield the discrete mapping of the goal function (eq. \ref{eq:gamma}) 
on the plane $z_0 \times m_0 $ shown in Fig. \ref{fig:dipping_regional_rtp}d.
The smallest value of this goal function (white diamond) pinpoints 
the optimal pair of $z_0$ and $m_0$.
By comparing the retrieved values of $z_0$ and $m_0$ (white diamond)  and
the true ones (red triangle), we can note an ambiguity involving these variables.
In this test, the retrieved depth to the top of 40 m is deeper than the true one and the 
retrieved total-magnetization intensity of 15 A/m is higher than the true one.

Although there is an ambiguity involving $z_0$ and $m_0$, the small residuals (Fig. \ref{fig:regional-results}a) indicate a reasonable fit of the inverted total-field anomaly
(Fig. \ref{fig:dipping_regional_rtp}a).
In all 36 inversions, we used the same cylinder-like initial guess (red prisms in Fig. \ref{fig:regional-results}b).
By assiging $z_0 = 40$ m and $m_0 = 15$ A/m (pinpointed as the white diamond in Fig. \ref{fig:dipping_regional_rtp}d), the estimated source (red prisms in Figs.\ref{fig:regional-results}c and d) recovers the shape of the  simulated dipping source 
(blue prisms in Figs.\ref{fig:regional-results}b-d) reasonably.

\subsection{Complex model test}

Here, we have simulated a complex high-angle dipping intrusion (blue prisms in Figs \ref{fig:complex_model} and \ref{fig:complex_result}) inspired by an alkaline vertical dipping intrusion. 
The simulated intrusion extends from $z_0=130$ m to $6\,130$ m along depth.
It is formed by $ L = 10 $ prisms, all of them with the same number of vertices $ V = 30 $ of thickness $ dz = 600 $ m. 
The horizontal coordinates of the origins $ O^k $ vary linearly from $ (x_0^0, y_0^0) = (-250, 250) $ m, at the shallowest prism, to $ (x_L^0, y_L^0) = (250, -750) $ m, at the deepest prism. 
These ensemble of 10 vertically juxtaposed prisms, exhibiting horizontal displacements between them, form a dyke-like intrusion, dipping at high angle to the northwest (blue prisms in Figs \ref{fig:complex_model} and \ref{fig:complex_result}). 
The radii defining the vertices of these prisms, $ r^k_j, k = 1, \dots, L$, $j = 1,\dots, V$, 
vary from $ 240 $ m to $ 1\,540 $ m and also differ from each other within the same prism. 
All prisms have a constant total magnetization with inclination $ -50^\circ $, declination $ 9^\circ $ and intensity $ m_0 = 12 $ A/m. 
We stress that the shape of the simulated complex model (blue prisms in Figs \ref{fig:complex_model} and \ref{fig:complex_result}) violates severely two constraints described in subsection \ref{sec:constraints}: $\varphi_{1}(\mathbf{p})$ (eq. \ref{eq:phi1})
and $\varphi_{2}(\mathbf{p})$ (eq. \ref{eq:phi2}).
The violation of these constraints can be viewed by the nonsmoothness feature of the adjacent radii defining the horizontal section of each vertical prism and by the nonsmoothness feature of the adjacent radii of the vertically adjacent prisms.

We calculate the total-field anomaly produced by this complex model, in an area of $ 100 $ km$^2 $, by simulating an airborne survey composed of 18 north-south flight lines distributed from $ -5\,000 $ m to $ 5\,000 $ m along the y axis and a single east-west tie line approximately located at $ x = 0 $ m. 
The data points are located on the undulated surface shown in Fig. \ref{fig:complex_model}a. Notice that both flight and tie lines are not perfectly straight. 
To compute the synthetic total-field anomaly, we consider a constant main geomagnetic field with inclination $ -21.5^\circ $ and declination $ -18.7^\circ $. 
Finally, we have contaminated the synthetic total-field anomaly with a additive pseudorandom Gaussian noise having mean and standard deviation equal to $0$ nT and $5$ nT, respectively (Fig. \ref{fig:complex_model}a).

To set up the cylinder-like initial guess, we calculate the RTP anomaly (Fig. \ref{fig:complex_rtp}a) of the noise-corrupted total-field anomaly 
(Fig. \ref{fig:complex_model}a) .
We have inverted the noise-corrupted total-field anomaly produced by the complex model by using 36 different pairs of depth to the top $ z_0 $ and total-magnetization intensity 
$ m_0 $ (Fig. \ref{fig:complex_rtp}b). 
Differently from the previous simulations, in this test, the grid of $ m_0 $ and $ z_0 $ 
does not contain the true ones (represented by the red triangle in Fig. \ref{fig:complex_rtp}b). 
All the 36 estimates, obtained considering a grid of 6 $\times$ 6 tentative values of  $z_0$ and $m_0$ (shown in  Fig. \ref{fig:complex_rtp}b), use: i) the true magnetization direction of the simulated complex model  (i.e.,  $ -50^\circ $, declination $ 9^\circ $), ii) the same interpretation model formed by $ L = 8 $ prisms, each one with $ V = 20 $ vertices, iii) the same cylinder-like initial guess, and iv) the same weights for the constraining functions: 
$\tilde{\alpha}_1 = 10^{-5}$, 
$\tilde{\alpha}_2 = 10^{-4}$, 
$\tilde{\alpha}_3 = 10^{-4}$, 
$\tilde{\alpha}_4 = 0$, 
$\tilde{\alpha}_5 = 0$, 
$\tilde{\alpha}_6 = 10^{-7}$, and 
$\tilde{\alpha}_7 = 10^{-5}$. 

Fig. \ref{fig:complex_rtp}b shows the goal function $ \Gamma(\mathbf{p}) $ (eq. \ref{eq:gamma}), with different total-magnetization intensity $ m_0 $ and depth-to-the-top $z_0$, on the plane ($ m_0 \times z_0 $). 
We note that a well-defined minimum region the goal function (dark blue region) contains the true pair of $z_0 = 130$ m and $m_0 = 12 $ A/m  (red triangle) and the optimum pair of 
$z_0 = 150$ m and $m_0 = 12.8 $ A/m (white diamond) which yields the smallest value of the goal function and will be used to retrieve the estimated model.


Fig. \ref{fig:complex_result}a shows the residuals defined as the difference
between the synthetic noise-corrupted magnetic data in Fig. \ref{fig:complex_model}a 
and the predicted data (not shown).
The cylinder-like initial guess ($ \hat{\mathbf{p}}_{(0)} $), shown 
in Fig. \ref{fig:complex_result}b by the red prisms, is composed by a set of eight prisms, has the same constant radii $ r^k_j = 800 $ m, $ k = 1, \dots, 8 $, $ j = 1, \dots, 20 $, 
the same thickness $ dz = 650 $ m and the same origin 
$ (x^k_0, y^k_0) = (-300, 300) $ m for all prisms of the interpretation model.

Figs. \ref{fig:complex_result}c and d show the estimated model (red prisms) 
obtained by using $z_0 = 150$ m and $m_0 = 12.8 $ A/m 
(white diamond in Fig. \ref{fig:complex_rtp}b).
Note that the this estimated model fits the noise-corrupted data 
(small residuals in Fig. \ref{fig:complex_result}a) 
and also retrieves the geometry of the true source 
(blue prisms in Figs. \ref{fig:complex_result}b-d). 
The inset in Fig. \ref{fig:complex_result}a shows that the residuals follow a normal distribution with mean $ \mu $ and standard deviation $ \sigma $ compatible with those values used to generate the noise-corrupted data. 
The estimated of depth to the bottom  ($ 5\,904.45 $ m) and volume ($ 11.19 $ km$^3 $) are underestimated, but still close to the true values ($ 6\,130 $ m and $ 12.60 $ km$^3 $). 
These results show that our method can also be very useful to interpret complex sources, even if they do not perfectly satisfy the constraints imposed to solve the nonlinear inverse problem.