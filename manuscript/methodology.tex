\section{Methodology}\label{sec:metodo}

\subsection{Forward problem}

Let $\mathbf{d}^{o}$ be the observed data vector, whose $i$th element $d^{o}_{i}$, $i = 1, \dots, N$, is the total-field anomaly produced by a 3-D source (Fig. \ref{fig:obs}(a)) at the point $(x_{i}, y_{i}, z_{i})$ of a Cartesian coordinate system with $x$-, $y$- and $z$- axes pointing to north, east and down, respectively. We assume that the direction of the total magnetization vector of the source is constant and known. We approximate the volume of the source by a set of $L$ vertically juxtaposed 3-D prisms (Fig. \ref{fig:obs}(b)) by following the same approach of \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013}. The depth to the top of the shallowest prism is defined by $z_{0}$ and $m_{0}$ is the constant total-magnetization intensity of all prisms. The horizontal cross-section of each prism (Fig. \ref{fig:prism_parameters}) 
is described by a polygon with a fixed number $V$ of vertices equally spaced from $0^{\circ}$ to $360^{\circ}$, which are described in polar coordinates referred to an internal origin $O^{k}$. The radii of the vertices ($r^{k}_{j}$, $j=1,\dots , V$, $k=1,\dots ,L$), the horizontal coordinates ($x_{0}^{k}$ and $y_{0}^{k}$, $k=1,\dots ,L$) of the origins $O^{k}$, $k=1,\dots ,L$, and the thickness $dz$ of the $L$ vertically stacked prisms (Fig. \ref{fig:obs}(b)) are arranged in a $M \times 1$ parameter vector $\mathbf{p}$, $M = L (V + 2) + 1$, given by
\begin{equation}
\mathbf{p} = \left[ \begin{array}{@{}*{12}{c}@{}}
{\mathbf{r}^{1}}^{\mathsf{T}} & x_{0}^{1} & y_{0}^{1} & \dots & {\mathbf{r}^{L}}^{\mathsf{T}} & x_{0}^{L} & y_{0}^{L} & dz \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:p-vector}
\end{equation}
where ``$^{\mathsf{T}}$" denotes transposition and $\mathbf{r}^{k}$ is a $V \times 1$ vector containing the radii $r^{k}_{j}$ 
of the $k$th prism.
Let $\mathbf{d} (\mathbf{p})$ be the predicted data vector, whose $i$th element 
\begin{equation}
d_{i} (\mathbf{p}) \equiv m_{0} \: \sum\limits_{k=1}^{L} f_{i}^{k}(\mathbf{r}^{k}, x_{0}^{k}, y_{0}^{k}, dz, z_{1}^{k}), \quad i = 1, \dots, N \: ,
\label{eq:predicted-data-i}
\end{equation}
is the total-field anomaly produced by the ensemble of $L$ prisms at the $i$th observation point ($x_{i}, y_{i}, z_{i}$). In eq. \ref{eq:predicted-data-i}, $f_{i}^{k}(\mathbf{r}^{k}, x_{0}^{k}, y_{0}^{k}, dz, z_{1}^{k})$ is the total-field anomaly produced, at the observation point ($x_{i}, y_{i}, z_{i}$), by the $k$th prism with unitary magnetization intensity and depth to the top $z_{1}^{k} = z_{0} + (k-1)dz$. We calculate $d_{i} (\mathbf{p})$ (eq. \ref{eq:predicted-data-i}) by using the Python package Fatiando a Terra \cite[]{uieda-etal2013}, which implements the formulas proposed by \cite{plouff1976}.


\subsection{Inverse problem formulation}

%The total-magnetization of the source $m_{0}$ and depth to the top of the shallowest 
%prism $z_{0}$ are hyperparameters of the inversion, i. e., they are not estimated during 
%the inversion, but their value influences the final solution. 
Given a set of tentative values for the total-magnetization intensity $m_{0}$ and 
depth to the top of the shallowest prism $z_{0}$, we solve a constrained non-linear 
problem to estimate the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}) 
by minimizing the goal function
\begin{equation}
\Gamma (\mathbf{p}) = \phi (\mathbf{p}) + \sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \varphi_{\ell}(\mathbf{p}) \: ,
\label{eq:gamma}
\end{equation}
subject to
\begin{equation}
p_{l}^{min} < p_{l} < p_{l}^{max}, \quad l = 1, \dots, M \: ,
\label{eq:inequality-constraint}
\end{equation}
where $\phi (\mathbf{p})$ is the data-misfit function given by
\begin{equation}\label{eq:misfit}
\phi (\mathbf{p}) = \frac{1}{N} \| \mathbf{d}^{o} - \mathbf{d}(\mathbf{p}) \|_{2}^{2} \: ,
\end{equation}
which represents the normalized squared Euclidean norm of the difference between the 
observed $\mathbf{d}^{o}$ and predicted $\mathbf{d}(\mathbf{p})$ data vector,
whose $i$th element is the predicted data $d_{i} (\mathbf{p})$ 
(eq. \ref{eq:predicted-data-i}).

The second term in the right side of eq. (\ref{eq:gamma}) represents the weighted sum of
the seven constraint functions $\varphi_{\ell}(\mathbf{p}), \: \ell = 1, \dots, 7$ 
described in the subsection \textit{Constraint functions} later in this article.
In eq. (\ref{eq:gamma}), $\alpha_{\ell}$ is a positive number representing 
the weight of the $\ell$th constraint function $\varphi_{\ell}(\mathbf{p})$.
These weights $\alpha_{\ell}$ will be rescaled and selected according to a criterion described in the subsection \textit{Computational procedures} later in this article.
In the inequality constraints (eq. \ref{eq:inequality-constraint}) 
$p_{l}^{min}$ and $p_{l}^{max}$ are, respectively, the lower and upper limits for the $l$th element $p_{l}$ of the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}). 
These limits are defined by the interpreter 
based on both the horizontal extent of the magnetic anomaly and the knowledge about the 
source.
On the discrete mapping of the goal function $\Gamma (\mathbf{p}_f)$ 
(eq. \ref{eq:gamma}), where $ \mathbf{p}_f $ is the estimated parameter vector at the final algorithm iteration, obtained by using each previously defined pair $(m_{0}, z_{0})$, we select the optimum values of $m_{0}$ and $z_{0}$ as those producing the smallest value of $\Gamma (\mathbf{p}_f)$.

To solve our nonlinear inverse problem for each pair of total-magnetization 
intensity $m_{0}$ and depth to the top of the shallowest prism $z_{0}$, 
we use a gradient-based method and, consequently, we need to define the gradient vector 
$\boldsymbol{\nabla}\Gamma(\mathbf{p})$ and Hessian matrix $\mathbf{H}(\mathbf{p})$ of 
the goal function $\Gamma(\mathbf{p})$ (eq. \ref{eq:gamma}):
\begin{equation}\label{eq:gamma_gradient}
\boldsymbol{\nabla}\Gamma (\mathbf{p}) = \boldsymbol{\nabla}\phi (\mathbf{p}) + 
\sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \boldsymbol{\nabla}\varphi_{\ell}(\mathbf{p})
\end{equation}
and
\begin{equation}\label{eq:gamma_hessian}
\mathbf{H} (\mathbf{p}) = \mathbf{H}_\phi (\mathbf{p}) + \sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \mathbf{H}_\ell \: ,
\end{equation}
where the gradient vector and the Hessian matrix of the misfit function 
$\phi(\mathbf{p})$ (eq. \ref{eq:gamma}) are respectively given by:
\begin{equation}\label{eq:phi_gradient}
\boldsymbol{\nabla} \phi(\mathbf{p}) = - \frac{2}{N}\mathbf{G}(\mathbf{p})^{\mathsf{T}}[\mathbf{d}^o - \mathbf{d}(\mathbf{p})]
\end{equation} 
and 
\begin{equation}\label{eq:phi_hessian}
\mathbf{H}_{\phi}(\mathbf{p}) = \frac{2}{N}\mathbf{G}(\mathbf{p})^{\mathsf{T}}\mathbf{G}(\mathbf{p}) \: .
\end{equation}
In eqs. \ref{eq:gamma_gradient} and \ref{eq:gamma_hessian}, the terms 
$\boldsymbol{\nabla} \varphi_{\ell}(\mathbf{p})$ and $\mathbf{H}_{\ell}$, 
$\ell = 1, \dots, 7$, are the gradient vectors and Hessian matrices of the constraint functions, respectively. In eqs. \ref{eq:phi_gradient} and \ref{eq:phi_hessian},
$\mathbf{G}(\mathbf{p})$ is an $N \times M$ matrix whose element $ij$ is the derivative of the predicted data $d_{i}(\mathbf{p})$ (eq. \ref{eq:predicted-data-i}) with respect to the $j$ element $p_{j}$ of 
the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}). Details about the constraint functions $\varphi_\ell(\mathbf{p})$, $\ell = 1, \dots, 7$, as well as the numerical procedure to solve this nonlinear inverse problem are given in the following sections.

\subsection{Constraint functions}\label{sec:constraints}

To explain the constraint functions $\varphi_{\ell}(\mathbf{p})$ (eq. \ref{eq:gamma}), $\ell = 1, \dots, 7$, used here to obtain stable solutions and introduce prior information about the magnetic source, we have organized them into the following three groups.

\subsubsection{Smoothness constraints}

This group is formed by variations of the first-order Tikhonov regularization \cite[][ p. 103]{aster-etal2019} that imposes smoothness on the radii $r_{j}^{k}$ and the Cartesian coordinates $x_{0}^{k}$ and $y_{0}^{k}$ of the origin $O^{k}$, $j = 1, \dots, V$, $k = 1, \dots, L$, defining the horizontal section of each prism (Fig.\ref{fig:obs}(b)).
They were proposed by \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} and play a very important role in introducing prior information about the shape of the source. 

The first constraint of this group is the \textit{smoothness constraint on the adjacent radii defining the horizontal section of each prism}. This constraint imposes that adjacent radii $r_{j}^{k}$ and $r_{j+1}^{k}$ within each prism must be close to each other. It forces the estimated prism to be approximately cylindrical. Mathematically, the constraint is given by \begin{equation}\label{eq:phi1}
\begin{split}
\varphi_{1}(\mathbf{p}) &= \sum\limits^{L}_{k=1}\left[\left(r^{k}_{V}-r^{k}_{1}\right)^2 + \sum\limits^{V-1}_{j=1}\left(r^{k}_{j}-r^{k}_{j+1}\right)^2\right]\\
 &= \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{1}\mathbf{R}_{1} \mathbf{p} \quad ,
\end{split}
\end{equation}
where
\begin{equation}
\mathbf{R}_{1} = 
\begin{bmatrix}
\mathbf{S}_{1} &
\mathbf{0}_{LV \times 1} \\
\end{bmatrix}_{LV \times M} \quad ,
\label{eq:R1-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{1} = 
\mathbf{I}_{L} \otimes 
\begin{bmatrix}
\left( \mathbf{I}_{V} - \mathbf{D}_{V}^\mathsf{T} \right) & \mathbf{0}_{V \times 2} \\
\end{bmatrix}_{V \times (V+2)} \quad ,
\label{eq:S1-matrix}
\end{equation}
$ \mathbf{0}_{LV \times 1} $ is an $ LV \times 1 $ vector with null elements,
$\mathbf{I}_{L}$ is the identity matrix of order $L$, ``$\otimes$" denotes the Kronecker product \cite[][ p. 243]{horn_johnson1991}, $\mathbf{0}_{V \times 2}$ is a $V \times 2$ matrix with null elements, 
$\mathbf{I}_{V}$ is the identity matrix of order $V$ and $\mathbf{D}_{V}^\mathsf{T}$ is the upshift permutation matrix of order $V$ \cite[][ p. 20]{golub-vanloan2013}. The gradient and Hessian of function $\varphi_{1}(\mathbf{p})$ (eq. \ref{eq:phi1}) are given by:
\begin{equation}\label{eq:phi1_grad}
\boldsymbol{\nabla}\varphi_{1}(\mathbf{p}) = 2 \mathbf{R}^\mathsf{T}_{1}\mathbf{R}_{1}\mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi1_hessian}
\mathbf{H}_{1}(\mathbf{p}) = 2\mathbf{R}^\mathsf{T}_{1}\mathbf{R}_{1} \quad .
\end{equation}

The second constraint of this group is the \textit{smoothness constraint on the adjacent radii of the vertically adjacent prisms}, which imposes that adjacent radii $r_{j}^{k}$ and $r_{j}^{k+1}$ within vertically adjacent prisms must be close to each other. This constraint forces the shape of all prisms to be similar to each other
and is given by
\begin{equation}\label{eq:phi2}
\begin{split}
\varphi_{2}(\mathbf{p}) &= \sum\limits^{L-1}_{k=1}\left[\sum\limits^{V}_{j=1}\left(r^{k+1}_{j}-r^{k}_{j}\right)^2\right] \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{2}\mathbf{R}_{2}\mathbf{p}
\end{split} \quad ,
\end{equation}
where 
\begin{equation}
\mathbf{R}_{2} = 
\begin{bmatrix}
\mathbf{S}_{2} & \mathbf{0}_{(L-1)V \times 1} \\
\end{bmatrix}_{(L-1)V \times M} \quad ,
\label{eq:R2-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{2} =
\left( 
\begin{bmatrix} \mathbf{I}_{L-1} & \mathbf{0}_{(L-1) \times 1} \end{bmatrix} -
\begin{bmatrix} \mathbf{0}_{(L-1) \times 1} & \mathbf{I}_{L-1} \end{bmatrix} 
\right) \otimes 
\begin{bmatrix} \mathbf{I}_{V} & \mathbf{0}_{V \times 2} \end{bmatrix} \quad ,
\label{eq:S2-matrix}
\end{equation}
$\mathbf{0}_{(L-1)V \times 1}$ is an $(L-1)V \times 1$ vector with null elements,
$\mathbf{0}_{(L-1) \times 1}$ is an $(L-1) \times 1$ vector with null elements and 
$\mathbf{I}_{L-1}$ is the identity matrix of order $L-1$. The gradient and Hessian of function $\varphi_{2}(\mathbf{p})$ (eq. \ref{eq:phi2}) are given by:
\begin{equation}\label{eq:phi2_grad}
\boldsymbol{\nabla}\varphi_{2}(\mathbf{p}) = 2\mathbf{R}^\mathsf{T}_{2}\mathbf{R}_{2}\mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi2_hessian}
\mathbf{H}_{2}(\mathbf{p}) = 2\mathbf{R}^\mathsf{T}_{2}\mathbf{R}_{2} \quad .
\end{equation}

The last constraint of this group is the \textit{smoothness constraint on the horizontal position of 
the arbitrary origins of the vertically adjacent prisms}. This constraint imposes that the estimated horizontal 
Cartesian coordinates $(x_{0}^{k}, y_{0}^{k})$ and $(x_{0}^{k+1}, y_{0}^{k+1})$ of the origins $O^{k}$ and $O^{k+1}$ 
of adjacent prisms must be close to each other. It forces the centers of the prisms to be vertically aligned. This constraint 
is given by
\begin{equation}\label{eq:phi3}
\begin{split}
\varphi_{3}(\mathbf{p}) &= \sum\limits^{L-1}_{k=1}\left[\left(x_{0}^{k+1} - x_{0}^{k}\right)^2 + \left(y_{0}^{k+1} - y_{0}^{k}\right)^2 \right] \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3}\mathbf{p}
\end{split} \quad ,
\end{equation}
where 
\begin{equation}
\mathbf{R}_{3} = 
\begin{bmatrix}
\mathbf{S}_{3} & \mathbf{0}_{(L-1)2 \times 1} \\
\end{bmatrix}_{(L-1)2 \times M} \quad ,
\label{eq:R3-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{3} =
\left( 
\begin{bmatrix} \mathbf{I}_{L-1} & \mathbf{0}_{(L-1) \times 1} \end{bmatrix} -
\begin{bmatrix} \mathbf{0}_{(L-1) \times 1} & \mathbf{I}_{L-1} \end{bmatrix} 
\right) \otimes 
\begin{bmatrix} \mathbf{0}_{2 \times V} & \mathbf{I}_{2} \end{bmatrix} \quad ,
\label{eq:S3-matrix}
\end{equation}
$\mathbf{0}_{(L-1)2 \times 1}$ is an $(L-1)2 \times 1$ vector with null elements,
$\mathbf{0}_{2 \times V}$ is a $2 \times V$ matrix with null elements and 
$\mathbf{I}_{2}$ is the identity matrix of order $2$. The gradient and Hessian of function $\varphi_{3}(\mathbf{p})$ (eq. \ref{eq:phi3}) are given by:
\begin{equation}\label{eq:phi3_grad}
\boldsymbol{\nabla}\varphi_{3}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3}\mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi3_hessian}
\mathbf{H}_{3}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3} \quad .
\end{equation}

\subsubsection{Equality constraints}

This group is formed by two constraints that were proposed by \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} by following the same approach proposed \cite{barbosa-etal1997} and \cite{barbosa-1999a}. 
They introduce a priori information about the shallowest prism and are suitable for outcropping sources.

The \textit{source’s outcrop constraint} imposes that the horizontal cross-section of the shallowest prism must be close to known outcropping boundary of the geologic source.
The horizontal cross-section of the known outcropping boundary separating the geologic source from the host rock is described by the radii $\tilde{r}_{1}^{0} \dots \tilde{r}_{V}^{0}$. Mathematically, this constraint is given by
\begin{equation}\label{eq:phi4}
\begin{split}
\varphi_{4}(\mathbf{p}) &= \left[ \sum\limits^{V}_{j=1}\left(r^{1}_{j}-\tilde{r}^{0}_{j}\right)^2\right] \\
&= \left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right)^{\mathsf{T}} 
\left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right)
\end{split} \quad ,
\end{equation}
where $\mathbf{a}$ is a $V \times 1$ vector containing the radii of the polygon defining the outcropping boundary
\begin{equation}
\mathbf{a} = \left[ \begin{array}{@{}*{12}{c}@{}}
\tilde{r}_{1}^{0} & \dots & \tilde{r}_{V}^{0} \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:a-vector}
\end{equation}
and
\begin{equation}
\mathbf{R}_{4} = 
\begin{bmatrix}
\mathbf{I}_{V} & \mathbf{0}_{V \times (M-V)} \\
\end{bmatrix}_{V\times M},
\label{eq:R4-matrix}
\end{equation}
where $\mathbf{I}_{V}$ is the identity matrix of order $V$ and 
$\mathbf{0}_{V \times (M-V)}$ is a $V \times (M-V)$ matrix with null elements.
The gradient and Hessian of function $\varphi_{4}(\mathbf{p})$ (eq. \ref{eq:phi4}) are given by:
\begin{equation}\label{eq:phi4_grad}
\boldsymbol{\nabla}\varphi_{4}(\mathbf{p}) = 2 \mathbf{R}_{4}^{\mathsf{T}} 
\left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right) \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi4_hessian}
\mathbf{H}_{4}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{4}\mathbf{R}_{4} \quad .
\end{equation}

The \textit{source's horizontal location constraint} imposes that the horizontal Cartesian coordinates of the origin within 
the shallowest prism must be as close as possible to a known outcropping point given by the horizontal Cartesian coordinates $(\tilde{x}_{0}^{0}, \: \tilde{y}_{0}^{0})$. 
This constraint is given by
\begin{equation}\label{eq:phi5}
\begin{split}
\varphi_{5}(\mathbf{p}) &= \left[\left(x_{0}^{1} - \tilde{x}_{0}^{0}\right)^2 
+ \left(y_{0}^{1} - \tilde{y}_{0}^{0}\right)^2\right] \\
&= \left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b} \right)^{\mathsf{T}}
\left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b}\right)
\end{split} \quad ,
\end{equation}
where $\mathbf{b}$ is a $2 \times 1$ vector containing the horizontal Cartesian coordinates of the outcropping point 
\begin{equation}
\mathbf{b} = \left[ \begin{array}{@{}*{12}{c}@{}}
\tilde{x}_{0}^{0} & \tilde{y}_{0}^{0} \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:b-vector}
\end{equation}
and
\begin{equation}
\mathbf{R}_{5} = 
\begin{bmatrix}
\mathbf{0}_{2 \times V} & \mathbf{I}_{2} & \mathbf{0}_{2 \times (M-V-2)} \\
\end{bmatrix}_{2 \times M},
\label{eq:R5-matrix}
\end{equation}
where $\mathbf{0}_{2 \times (M-V-2)}$ is a $2 \times (M-V-2)$ matrix 
with null elements. 
The gradient and Hessian of function $\varphi_{5}(\mathbf{p})$ (eq. \ref{eq:phi5}) are given by:
\begin{equation}\label{eq:phi5_grad}
\boldsymbol{\nabla}\varphi_{5}(\mathbf{p}) = 2\mathbf{R}_{5}^{\mathsf{T}}
\left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b}\right) \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi5_hessian}
\mathbf{H}_{5}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{5}\mathbf{R}_{5} \quad .
\end{equation}

\subsubsection{Minimum Euclidean norm constraints}

Two constraints use the zeroth-order Tikhonov regularization with the purpose of obtaining stable solutions without introducing prior information about the shape of the source. 
However, these two constraints combined with the interpretation model impose 
source compactness. 

The \textit{Minimum Euclidean norm of the radii} imposes that 
all estimated radii within each prism must be close to null values. This constraint was proposed by \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} and can be rewritten as follows
\begin{equation}\label{eq:phi6}
\begin{split}
\varphi_{6}(\mathbf{p}) &= \sum\limits^{L}_{k=1}\sum\limits^{V}_{j=1}\left(r_{j}^{k}\right)^2 \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}_{6}^{\mathsf{T}} \mathbf{R}_{6} \mathbf{p}
\end{split} \quad ,
\end{equation}
where
\begin{equation}
\mathbf{R}_{6} = 
\begin{bmatrix}
\mathbf{S}_{6} & \mathbf{0}_{(M-1) \times 1} \\
\mathbf{0}_{1 \times (M-1)} & 0 \\
\end{bmatrix}_{M\times M} \quad ,
\label{eq:R6-matrix}
\end{equation}
and 
\begin{equation}
\mathbf{S}_{6} = 
\mathbf{I}_{L} \otimes 
\begin{bmatrix}
\mathbf{I}_{V}      & \mathbf{0}_{V \times 2} \\
\mathbf{0}_{2 \times V} & \mathbf{0}_{2 \times 2} \\
\end{bmatrix}_{(V+2) \times (V+2)} \quad ,
\label{eq:S6-matrix}
\end{equation}
where $\mathbf{0}_{2 \times 2}$ is a $2 \times 2$ matrix with null elements,
$\mathbf{0}_{V \times 2}$ is a $V \times 2$ matrix with null elements and
$\mathbf{0}_{2 \times V}$ is a $2 \times V$ matrix with null elements.
The gradient and Hessian of function $\varphi_{6}(\mathbf{p})$ (eq. \ref{eq:phi6}) are given by:
\begin{equation}\label{eq:phi6_grad}
\boldsymbol{\nabla}\varphi_{6}(\mathbf{p}) = 2 \mathbf{R}_{6}^{\mathsf{T}} \mathbf{R}_{6} \mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi6_hessian}
\mathbf{H}_{6}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{6}\mathbf{R}_{6} \quad .
\end{equation}

The other constraint, the \textit{Minimum Euclidean norm of the prism thickness}, imposes that the thickness of all prisms must be close to zero. We present this constraint to introduce a priori information about the maximum depth extent of the source which in turn is dependent on the depth to the top of the shallowest prism $z_{0}$. It is given by
\begin{equation}\label{eq:phi7}
\begin{split}
\varphi_{7}(\mathbf{p}) &= dz^2 \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}_{7}^{\mathsf{T}} \mathbf{R}_{7} \mathbf{p}
\end{split} \quad ,
\end{equation}
where
\begin{equation}
\mathbf{R}_{7} =
\begin{bmatrix}
\mathbf{0}_{(M-1) \times (M-1)} & \mathbf{0}_{(M-1) \times 1} \\
\mathbf{0}_{1 \times (M-1)} & 1 \\
\end{bmatrix}_{ M \times M } \quad .
\end{equation}
The gradient and Hessian of function $\varphi_{7}(\mathbf{p})$ (eq. \ref{eq:phi7}) are given by:
\begin{equation}\label{eq:phi7_grad}
\boldsymbol{\nabla}\varphi_{7}(\mathbf{p}) = 2 \mathbf{R}_{7}^{\mathsf{T}} \mathbf{R}_{7} \mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi7_hessian}
\mathbf{H}_{7}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{7}\mathbf{R}_{7} \quad .
\end{equation}

\subsection{Computational procedures}

The computational procedures of our method require the definition of:
(1) the initial guess, (2) the upper and lower limits in the inequality constraints (eq. \ref{eq:inequality-constraint}), (3) the nonlinear inverse algorithm, and 
(4) the weights $ \alpha_{\ell} $ (eq. \ref{eq:gamma}).

\subsubsection{Initial guess and inequality constraints}

Estimating, from the total-field anomaly, the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}) that minimizes the goal function $\Gamma(\mathbf{p})$ (eq. \ref{eq:gamma}) 
for a given pair of total-magnetization intensity $m_{0}$ and depth to the top of the 
shallowest prism $z_{0}$, subject to the inequality constraint 
(eq. \ref{eq:inequality-constraint}), is a nonlinear inverse problem 
which requires an initial guess of the 3D source shape. 
The initial guess is a simple cylinder whose radius and horizontal Cartesian coordinates of its center were taken after computing the reduction-to-the-pole of the observed total-field anomaly (RTP anomaly).
We start by computing the RTP anomaly, which in turn has three purposes.
The first one is verifying if the used total-magnetization direction is valid.
The second purpose is defining the upper and lower limits of the inequality constraints 
(eq. \ref{eq:inequality-constraint}).
Finally, the third purpose of the RTP anomaly is defining the radius and horizontal Cartesian coordinates of the center of the a cylindrical body used as initial guess.

It is well known that if the source has a uniform magnetization direction, 
the RTP anomaly is predominantly positive and decays to zero close to its 
horizontal boundaries \cite[e.g.,][p. 331]{blakely1996}. 
To compute this transformation, however, the interpreter must use declination and
inclination values close to those defining the true total-magnetization direction
of the source. 
Hence, the interpreter can validate the total-magnetization direction of the source 
by verifying if the computed RTP anomaly shows predominantly positive values.

By using the computed RTP anomaly, we define the upper and lower limits 
($p_{l}^{min}$ and $p_{l}^{max}$) for each parameter $p_{l}$, $l = 1, \dots, M$, 
in the inequality constraints (eq. \ref{eq:inequality-constraint}). 
For the parameters representing the radii of the vertices of all prisms 
($r^{k}_{j}$, $j=1,\dots , V$, $k=1,\dots ,L$), the lower limit $p_{l}^{min}$ 
is close to zero and the upper limit $p_{l}^{max}$ is approximately defined by 
the radius of a circular area encompassing the region where the RTP anomaly is 
positive and decays to zero.
The lowermost and uppermost $x-$ and $y-$ coordinates of this circular area 
are used to define, respectively, the limits $p_{l}^{min}$ and $p_{l}^{max}$
for the parameters $p_{l}$ representing the horizontal coordinates
($x_{0}^{k}$ and $y_{0}^{k}$, $k=1,\dots ,L$) of the origins $O^{k}$, 
$k=1,\dots ,L$. 
We set the lower and upper limits for the parameter $p_{l}$ 
representing the thickness $dz$ of all prisms by using, respectively, 
a value close to zero and a large value resulting in a 
bottom depth greater than that we expect for the true source. 

To define the radius and the center of the cylinder-like initial guess, we 
use the radius and the $x-$ and $y-$ coordinates of the center of the circular area encompassing the region where the RTP anomaly is positive.
This definition does not require high accuracy. 
After defining the radius and the horizontal Cartesian coordinates of the center 
of the cylinder-like initial guess, we set the ranges of the depth to the top of the shallowest prism $ z_0 $ and the total-magnetization intensity $m_{0}$ based on prior information such as petrophysical studies.
In practice, the range of $ z_0 $ usually starts at the topography ($ z_0=0 $) and the interpreter must choose the intervals of the range.
Each pair of $ z_0 $ and $m_{0}$ within the grid formed by their ranges represents an independent inversion.
We point out that, although the initial guess $ \mathbf{p}_0 $ does not change through the grid, the values of $ z_0 $ and $m_{0}$ does change.
All of the cylinder-like initial guesses differ from each other by the vertical position and magnetization intensity.
Based on the expected complexity of the magnetic source, the interpreter should set the number of prisms $ L $ and the number of the vertices $ V $ as small as possible.
Next, we run forward modeling of the total-field anomaly aiming at adjusting the thickness $ dz $ that is not defined by the RTP anomaly.
We set a thickness $ dz $ greater than the expected one and evaluate the goal function $ \Gamma(\mathbf{p}_0) $ for every initial guess $ \mathbf{p}_0 $ belonging to the grid.
If the discrete map of the goal function $ \Gamma(\mathbf{p}_0) $ produces a minimum, the thickness $ dz $ is selected for the inversion.
The minimum and maximum thickness bounds are defined as close to zero and greater than the $ dz $, respectively.
This step does not require such rigor since $ dz $ is ultimately defined at the final iteration of the inversion.
Note that this forward modeling is carried out before performing the inversion 
and the resulting cylinder-like body may produce an inaccurate data fitting.

\subsubsection{Inversion algorithm}

Here, we use the Levenberg-Marquardt algorithm \cite[e.g., ][ p. 240]{aster-etal2019} to solve the nonlinear inverse problem given by eq. \ref{eq:gamma}.
The Levenberg-Marquardt algorithm is an iterative gradient-based method that, at each iteration $\kappa$, updates the estimate parameter vector $\hat{\mathbf{p}}_{(\kappa)}$ (where the superscript hat ``~$\hat{}$~" denotes estimated) to obtain a new estimated parameter vector $\hat{\mathbf{p}}_{(\kappa + 1)}$.
We compute this update by following the same strategy of \cite{barbosa-1999b}, \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} to incorporate the inequality constraint (eq. \ref{eq:inequality-constraint}). 
This strategy consists in transforming each element $\hat{p}_{l} \in (p_{l}^{min}, p_{l}^{max})$ of the estimated parameter vector $\hat{\mathbf{p}}_{(\kappa)}$ 
into the element $\hat{p}^{\dagger}_{l} \in (- \infty, + \infty)$ of an 
unconstrained vector $\hat{\mathbf{p}}^{\dagger}_{(\kappa)}$ as follows:
\begin{equation}\label{eq:inequality-function}
\hat{p}^{\dagger}_{l} = -\ln\left(\frac{p_{l}^{max} - \hat{p}_{l}}{\hat{p}_{l} - p_{l}^{min}}\right) \: ,
\end{equation}
where $p_{l}^{min}$ and $p_{l}^{max}$ are defined in the inequality constraint 
(eq. \ref{eq:inequality-constraint}).
The inverse transformation of each element $\hat{p}^{\dagger}_{l} \in (- \infty, + \infty)$ into the element $\hat{p}_{l} \in (p_{l}^{min}, p_{l}^{max})$ is the following:
\begin{equation}\label{eq:inv-inequality-function}
\hat{p}_{l} = p_{l}^{min} + \left(\frac{p_{l}^{max} - p_{l}^{min}}{ 1 + e^{-\hat{p}^{\dagger}_{l}} }\right) \: .
\end{equation}

At each iteration $\kappa$ of our algorithm, a correction 
$\boldsymbol{\Delta}\hat{\mathbf{p}}^{\dagger}_{(\kappa)}$ for the
unconstrained vector $\hat{\mathbf{p}}^{\dagger}_{(\kappa)}$
is computed by solving the following linear system:
\begin{equation}\label{eq:linear-system}
\mathbf{Q}_{(\kappa)}^{-1} \left[\mathbf{Q}_{(k)} \mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(\kappa)}) \mathbf{Q}_{(\kappa)} + \lambda_{(\kappa)} \mathbf{I}_{M} \right] 
\mathbf{Q}_{(\kappa)}^{-1} \boldsymbol{\Delta} \hat{\mathbf{p}}^{\dagger}_{(\kappa)} 
= -\boldsymbol{\nabla}\Gamma(\hat{\mathbf{p}}_{(\kappa)}) \: ,
\end{equation}
where $\lambda_{(\kappa)}$ is a positive scalar (known as Marquardt parameter) which is adjusted at each iteration and is associated with the Levenberg-Marquardt method \cite[e.g., ][ p. 240]{silva-2001,aster-etal2019},
$\mathbf{I}_{M}$ is the identity matrix with order $M$, 
$\boldsymbol{\nabla}\Gamma(\hat{\mathbf{p}}_{(\kappa)})$
is the gradient of the goal function (eq. \ref{eq:gamma_gradient}), 
$\mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(\kappa)})$ is a matrix given by
\begin{equation}\label{eq:H-dagger}
\mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(\kappa)}) = \mathbf{H}(\hat{\mathbf{p}}_{(\kappa)})\mathbf{T}(\hat{\mathbf{p}}_{(\kappa)}) 
\end{equation}
and $\mathbf{Q}_{(\kappa)}$ is a diagonal matrix proposed by \cite{marquardt_algorithm_1963} for scaling the parameter $\lambda_{(\kappa)}$ 
at each iteration.
The element $ll$ of this diagonal matrix is given by
\begin{equation}\label{eq:Q-matrix}
q_{ll} = \frac{1}{\sqrt{h^{\dagger}_{ll}}} \: ,
\end{equation}
where $h^{\dagger}_{ll}$ is the element $ll$ of the matrix $\mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(\kappa)})$ (eq. \ref{eq:H-dagger}). 
In eq. \ref{eq:H-dagger}, $\mathbf{H}(\hat{\mathbf{p}}_{(\kappa)})$ is the Hessian matrix of the goal function (eq. \ref{eq:gamma_hessian}) and $\mathbf{T}(\hat{\mathbf{p}}_{(\kappa)})$ is a diagonal matrix whose element $ll$ is given by
\begin{equation}\label{eq:inequality-diag}
t_{ll} = \frac{(p_{l}^{max} - \hat{p}_{l} + \epsilon)(\hat{p}_{l} - p_{l}^{min} + \epsilon)}{p_{l}^{max} - p_{l}^{min}} \: ,
\end{equation}
where $\hat{p}_{l}$ is the $l$th element of the estimated parameter vector 
$\hat{\mathbf{p}}_{(\kappa)}$ and $\epsilon$ is a small positive number 
($\approx 10^{-2}$) used to prevent null values.

After estimating $\boldsymbol{\Delta} \hat{\mathbf{p}}^{\dagger}_{(\kappa)}$ by 
solving the linear system (eq. \ref{eq:linear-system}), we update the unconstrained 
vector by computing
\begin{equation}\label{eq:p-k1-dagger}
\hat{\mathbf{p}}^{\dagger}_{(\kappa + 1)} =
\hat{\mathbf{p}}^{\dagger}_{(\kappa)} +
\boldsymbol{\Delta} \hat{\mathbf{p}}^{\dagger}_{(\kappa)} \: .
\end{equation}
Next, we compute the elements of an updated parameter vector $\hat{\mathbf{p}}_{(\kappa + 1)}$ by using eq. \ref{eq:inv-inequality-function}.
Finally, we stop the iterative process by evaluating the invariance of the 
goal function (eq. \ref{eq:gamma}) along successive iterations.
Specifically, we check if the inequality
\begin{equation}\label{eq:stop-criterion}
 \left| \frac{\Gamma (\hat{\mathbf{p}}_{(\kappa +1)}) - 
 \Gamma (\hat{\mathbf{p}}_{(\kappa)})}
 {\Gamma (\hat{\mathbf{p}}_{(\kappa)})} 
 \right| \le \tau
\end{equation}
holds, where $\tau$ is a threshold value on the order of $10^{-3}$ to $10^{-4}$. 
Usually, the inversion algorithm converges at $8$-$12$ iterations.
In the evaluation of the goal function (eq. \ref{eq:gamma}), we compute the 
constraint functions $\varphi_{\ell}(\mathbf{p})$ (eqs. \ref{eq:phi1}, \ref{eq:phi2},
\ref{eq:phi3}, \ref{eq:phi4}, \ref{eq:phi5}, \ref{eq:phi6} and \ref{eq:phi7}), 
$\ell = 1, \dots, 7$, by using the expressions which are written as sum of 
terms instead of those defined by sparse matrices.


\subsubsection{Choice of weights $\alpha_{1}-\alpha_{7}$}

Attributing values to the weights $ \alpha_{\ell} $ (eq. \ref{eq:gamma}) is an important feature of our method. 
However, there is no analytical rule to define them and their values can be dependent on the particular characteristics of the type of geological setting where the method is being applied \cite[]{silva-2001}. 

At this point, we draw attention that the weights $ \alpha_{\ell}$ (eq. \ref{eq:gamma}) are a dimensional 
quantity. 
Note that the units of the data-misfit function (eq. \ref{eq:misfit}) and the constraint functions 
(eqs. \ref{eq:phi1}, \ref{eq:phi2}, \ref{eq:phi3}, \ref{eq:phi4}, \ref{eq:phi5}, 
\ref{eq:phi6} and \ref{eq:phi7}), are nT$^{2}$ and $m^{2}$, respectively.
Because we set the unit of the goal function (eq. \ref{eq:gamma}) as nT$^{2}$, the unit of the weights 
$ \alpha_{\ell} $ (eq. \ref{eq:gamma}) is nT$^{2}$m$^{-2}$.

The physical dimensions of the weights $ \alpha_{\ell}$ makes assignment of their values problem dependent. 
To make these weights comparable to each other, we normalize the $ \alpha_{\ell} $ 
values as follows:
\begin{equation}\label{eq:alphas}
\alpha_{\ell} = \tilde{\alpha}_\ell \frac{E_\phi}{E_\ell}, \quad \ell = 1,\dots, 7,
\end{equation}
where $\tilde{\alpha}_\ell$ is a positive scalar and $ E_\phi/E_\ell $ is a normalizing
factor allowing the $\tilde{\alpha}_\ell$ to be independent of the physical units used.
In this equation, $ E_\ell $ represents the 
trace of the Hessian matrix $\mathbf{H}_{\ell}$ (eqs \ref{eq:phi1_hessian}, 
\ref{eq:phi2_hessian}, \ref{eq:phi3_hessian}, \ref{eq:phi4_hessian}, \ref{eq:phi5_hessian}, 
\ref{eq:phi6_hessian}, and \ref{eq:phi7_hessian}) of the $\ell$th constraining function 
$\varphi_{\ell}(\mathbf{p})$ (eqs \ref{eq:phi1}, \ref{eq:phi2}, \ref{eq:phi3}, 
\ref{eq:phi4}, \ref{eq:phi5}, \ref{eq:phi6}, and \ref{eq:phi7}). 
The constant $E_\phi$ is the trace of the Hessian matrix 
$\mathbf{H}_{\phi}(\hat{\mathbf{p}}_{(0)})$ (eq. \ref{eq:phi_hessian}) of the misfit function 
$\phi(\mathbf{p})$ (eq. \ref{eq:misfit}) computed with the initial approximation $\hat{\mathbf{p}}_{(0)}$ 
for the parameter vector $ \mathbf{p} $ (eq. \ref{eq:p-vector}) at the beginning of the inversion algorithm. 
Note that the trace of the Hessian matrix $\mathbf{H}_{\ell}$ is dimensionless and 
the trace of the Hessian matrix $\mathbf{H}_{\phi}(\hat{\mathbf{p}}_{(0)})$ has unit of nT$^{2}\cdot$m$^{-2}$.
Thus, the positive scalars $\tilde{\alpha}_\ell$ in eq. \ref{eq:alphas} are dimensionless quantities.

According to this empirical strategy, the weights $ \alpha_{\ell} $ 
(eq. \ref{eq:gamma}) are redefined using eq. \ref{eq:alphas}, in which the weights $\tilde{\alpha}_\ell$ are positive scalars, of physical units and less dependent 
on the particular characteristics of the interpretation geological setting.


\subsubsection{Practical considerations}

The values attributed to the dimensionless weights $\tilde{\alpha}_{1} - \tilde{\alpha}_{7}$ 
(eq. \ref{eq:alphas}) significantly impact the estimated models and cannot be 
automatically set without the interpreter’s judgment. 
Based on our practical experience, we suggest some 
empirical procedures for setting these parameters.

The parameters $\tilde{\alpha}_1$ and $\tilde{\alpha}_2$ impose prior information on the 
shape of the horizontal cross-section of the prisms. 
The first one forces all prisms to have a circular horizontal cross-section, while 
the second forces all prisms to have a similar horizontal cross-section.
Generally, their values vary from $10^{-5}$ to $10^{-3}$ and differ from
each other by one order of magnitude, at most.
The parameter $\tilde{\alpha}_3$ also varies from $10^{-5}$ to $10^{-3}$ and 
controls the relative position of adjacent prisms forming the model.
A high value privileges a vertical estimated body, whereas a small value 
tends to generate an inclined estimated body.

In comparison to $\tilde{\alpha}_1$, $\tilde{\alpha}_2$ and $\tilde{\alpha}_3$,
the other parameters usually have smaller values varying from $10^{-8}$ to $10^{-4}$.
The parameters $\tilde{\alpha}_4$ and $\tilde{\alpha}_5$ are used when a priori
information about the source is available at the study area.
The parameter $\tilde{\alpha}_6$ has a purely mathematical meaning and it is 
used only to obtain stable solutions for the inverse problem.
Its value is set to be as small as possible.
The parameter $\tilde{\alpha}_7$ controls the total-vertical extension of the 
the estimated body. 
The greater its value, the shallower the estimated depth to the bottom of the source will be 
and vice versa.
A general rule is starting with values 
$\tilde{\alpha}_1 = 10^{-4}$, $\tilde{\alpha}_2 = 10^{-4}$, $\tilde{\alpha}_3 = 10^{-4}$,
$\tilde{\alpha}_4 = 0$, $\tilde{\alpha}_5 = 0$, $\tilde{\alpha}_6 = 10^{-7}$, 
$\tilde{\alpha}_7 = 10^{-5}$ and change them to refine the results.
Finally, we stress that $\tilde{\alpha}_1 - \tilde{\alpha}_7$ (eq. \ref{eq:alphas})
do not change along the iterations.

