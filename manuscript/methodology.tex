\section{Methodology}\label{sec:metodo}

\subsection{Forward problem}

Let $\mathbf{d}^{o}$ be the observed data vector, whose $i$th element $d^{o}_{i}$, $i = 1, \dots, N$, is the total-field 
anomaly produced by a 3-D source (Fig. \ref{fig:obs}a) at the point $(x_{i}, y_{i}, z_{i})$ of a Cartesian coordinate 
system with $x$, $y$ and $z$ axes pointing to north, east and down, respectively. We assume that the direction of the 
total magnetization vector of the source is constant and known. 
We approximate the volume of the source by a set of $L$ vertically juxtaposed 3-D prisms 
(Fig. \ref{fig:obs}b) by following the same approach of \citet{oliveirajr-etal2011} and \citet{oliveirajr-barbosa2013}. 
The depth to the top of the shallowest prism is defined by $z_{0}$ and $m_{0}$ is the constant total-magnetization 
intensity of all prisms. 
The horizontal cross-section of each prism is described by a polygon with a fixed number 
$V$ of vertices equally spaced from $0^{\circ}$ to $360^{\circ}$, which are described in polar coordinates 
referred to an internal origin $O^{k}$ . 
The radii of the vertices ($r^{k}_{j}$, $j=1,\dots , V$, $k=1,\dots ,L$), the horizontal coordinates ($x_{0}^{k}$ and $y_{0}^{k}$, $k=1,\dots ,L$) 
of the origins $O^{k}$, $k=1,\dots ,L$, and the depth extent $dz$ of the $L$ vertically stacked prisms (Fig. \ref{fig:obs}b) are arranged in a 
$M \times 1$ parameter vector $\mathbf{p}$, $M = L (V + 2) + 1$, given by
\begin{equation}
\mathbf{p} = \left[ \begin{array}{@{}*{12}{c}@{}}
{\mathbf{r}^{1}}^{\mathsf{T}} & x_{0}^{1} & y_{0}^{1} & \dots & {\mathbf{r}^{L}}^{\mathsf{T}} & x_{0}^{L} & y_{0}^{L} & dz \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:p-vector}
\end{equation}
where ``$^{\mathsf{T}}$" denotes transposition and $\mathbf{r}^{k}$ is a $V \times 1$ vector containing the radii $r^{k}_{j}$ 
of the $k$th prism.
Let $\mathbf{d} (\mathbf{p})$ be the predicted data vector, whose $i$th element 
\begin{equation}
d_{i} (\mathbf{p}) \equiv \sum\limits_{k=1}^{L} f_{i}^{k}(\mathbf{r}^{k}, x_{0}^{k}, y_{0}^{k}, dz, z_{1}^{k}, m_{0}), \quad i = 1, \dots, N \: ,
\label{eq:predicted-data-i}
\end{equation}
is the total-field anomaly produced by the ensemble of $L$ prisms at the $i$th observation point ($x_{i}, y_{i}, z_{i}$). 
In eq. \ref{eq:predicted-data-i}, $f_{i}^{k}(\mathbf{r}^{k}, x_{0}^{k}, y_{0}^{k}, dz, z_{1}^{k}, m_{0})$ is the total-field anomaly 
produced, at the observation point ($x_{i}, y_{i}, z_{i}$), by the $k$th prism, with depth to the top $z_{1}^{k} = z_{0} + (k-1)dz$.
We calculate $d_{i} (\mathbf{p})$ (eq. \ref{eq:predicted-data-i}) by using the Python package Fatiando a Terra \citep{uieda-etal2013}, 
which implements the formulas proposed by \cite{plouff1976}.

\subsection{Inverse problem formulation}

Given a set of tentative values for depth to the top of the shallowest prism $z_{0}$ and for the intensity of the 
total-magnetization of the source $m_{0}$, we solve a constrained non-linear problem to estimate the parameter 
vector $\mathbf{p}$ (eq. \ref{eq:p-vector}) by minimizing the objective function
\begin{equation}
\Gamma (\mathbf{p}) = \phi (\mathbf{p}) + \sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \varphi_{\ell}(\mathbf{p}) \: ,
\label{eq:gamma}
\end{equation}
subject to
\begin{equation}
p_{l}^{min} < p_{l} < p_{l}^{max}, \quad l = 1, \dots, M \: ,
\label{eq:inequality-constraint}
\end{equation}
where $\varphi (\mathbf{p})$ is the data-misfit function given by
\begin{equation}\label{eq:misfit}
\phi (\mathbf{p}) = \frac{1}{N} \| \mathbf{d}^{o} - \mathbf{d}(\mathbf{p}) \|_{2}^{2} \: ,
\end{equation}
which represents the normalized squared Euclidean norm of the difference between the observed data vector $\mathbf{d}^{o}$ and 
the predicted data vector $\mathbf{d}(\mathbf{p})$, $\alpha_{\ell}$ is a small positive number representing the weight of the 
$\ell$th constraint function $\varphi_{\ell}(\mathbf{p})$ and $p_{l}^{min}$ and $p_{l}^{max}$ are, respectively, the lower and 
upper limits for the $l$th element $p_{l}$ of the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}). 
These limits are defined by the interpreter based on both the horizontal extent of the magnetic anomaly and the knowledge 
about the source.
We use the Levenberg–Marquardt method \citep[][ p. 240]{aster-etal2019} to minimize the objective function 
$\Gamma (\mathbf{p})$ (equation \ref{eq:gamma}) and introduce the inequality constraints 
(equation \ref{eq:inequality-constraint}) by using a strategy similar to that presented by \citet{barbosa-etal1999}.

\subsection{Constraint functions}

We have divided the constraint functions $\varphi_{\ell}(\mathbf{p})$ (eq. \ref{eq:gamma}), $\ell = 1, \dots, 7$, used here to 
obtain stable solutions and introduce a priori information about the magnetic source into three groups. 

\subsubsection{Smoothness constraints}

This group is formed by variations of the first-order Tikhonov regularization \citep[][ p. 103]{aster-etal2019}
and impose smoothness on the radii $r_{j}^{k}$ and the Cartesian coordinates $x_{0}^{k}$ and $y_{0}^{k}$ of the origin 
$O^{k}$, $j = 1, \dots, V$, $k = 1, \dots, L$, defining the horizontal section of each prism (Fig. \ref{fig:obs}b).
They were proposed by \citet{oliveirajr-etal2011} and \citet{oliveirajr-barbosa2013} and play a very 
role in introducing a priori information about the shape of the source. 

The first constraint of this group is the \textit{Smoothness constraint on the adjacent radii defining the horizontal 
section of each vertical prism}. This constraint imposes that adjacent radii $r_{j}^{k}$ and $r_{j+1}^{k}$ within each 
prism must be close to each other. It forces the estimated prism to be approximately cylindrical. 
We have conveniently rewritten this constraint in matrix form as follows:
\begin{equation}
\varphi_{1}(\mathbf{p}) = \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{1}\mathbf{R}_{1} \mathbf{p} \: ,
\label{eq:phi1}
\end{equation}
where 
\begin{equation}
\mathbf{R}_{1} = \begin{bmatrix} 
\mathbf{S}_{1} & \mathbf{0}_{LV \times 1} \\
\end{bmatrix}_{LV \times M} \quad ,
\label{eq:R1-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{1} = 
\mathbf{I}_{L} \otimes 
\begin{bmatrix}
\left( \mathbf{I}_{V} - \mathbf{D}_{V}^\mathsf{T} \right) & \mathbf{0}_{V \times 2} \\
\end{bmatrix} \quad ,
\label{eq:S1-matrix}
\end{equation}
$\mathbf{0}_{LV \times 1}$ is an $LV \times 1$ vector with null elements, 
$\mathbf{I}_{L}$ is the identity matrix of order $L$, ``$\otimes$" denotes the Kronecker product 
\citep[][ p. 243]{horn_johnson1991}, $\mathbf{0}_{V \times 2}$ is a $V \times 2$ matrix with null elements, 
$\mathbf{I}_{V}$ is the identity matrix of order $V$ and $\mathbf{D}_{V}^\mathsf{T}$ is the upshift permutation 
matrix of order $V$ \citep[][ p. 20]{golub-vanloan2013}.

The second constraint of this group is the \textit{Smoothness constraint on the adjacent radii of the 
vertically adjacent prisms}, which imposes that adjacent radii $r_{j}^{k}$ and $r_{j}^{k+1}$ within vertically 
adjacent prisms must be close to each other. This constraint forces the shape of all prisms to be similar to each other
and is given by
\begin{equation}
\varphi_{2}(\mathbf{p}) = \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{2}\mathbf{R}_{2}\mathbf{p} \quad ,
\label{eq:phi2}
\end{equation}
where 
\begin{equation}
\mathbf{R}_{2} = 
\begin{bmatrix}
\mathbf{S}_{2} & \mathbf{0}_{(L-1)V \times 1} \\
\end{bmatrix}_{(L-1)V \times M} \quad ,
\label{eq:R2-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{2} =
\left( 
\begin{bmatrix} \mathbf{I}_{L-1} & \mathbf{0}_{(L-1) \times 1} \end{bmatrix} -
\begin{bmatrix} \mathbf{0}_{(L-1) \times 1} & \mathbf{I}_{L-1} \end{bmatrix} 
\right) \otimes 
\begin{bmatrix} \mathbf{I}_{V} & \mathbf{0}_{V \times 2} \end{bmatrix} \quad ,
\label{eq:S2-matrix}
\end{equation}
$\mathbf{0}_{(L-1)V \times 1}$ is an $(L-1)V \times 1$ vector with null elements,
$\mathbf{0}_{(L-1) \times 1}$ is an $(L-1) \times 1$ vector with null elements and 
$\mathbf{I}_{L-1}$ is the identity matrix of order $L-1$.

The last constraint of this group is the \textit{Smoothness constraint on the horizontal position of 
the arbitrary origins of the vertically adjacent prisms}. This constraint imposes that the estimated horizontal 
Cartesian coordinates $(x_{0}^{k}, y_{0}^{k})$ and $(x_{0}^{k+1}, y_{0}^{k+1})$ of the origins $O^{k}$ and $O^{k+1}$ 
of adjacent prisms must be close to each other. It forces the prisms to be vertically aligned. This constraint 
is given by
\begin{equation}
\varphi_{3}(\mathbf{p}) = \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3}\mathbf{p} \quad ,
\label{eq:phi3}
\end{equation}
where 
\begin{equation}
\mathbf{R}_{3} = 
\begin{bmatrix}
\mathbf{S}_{3} & \mathbf{0}_{(L-1)2 \times 1} \\
\end{bmatrix}_{(L-1)2 \times M} \quad ,
\label{eq:R3-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{3} =
\left( 
\begin{bmatrix} \mathbf{I}_{L-1} & \mathbf{0}_{(L-1) \times 1} \end{bmatrix} -
\begin{bmatrix} \mathbf{0}_{(L-1) \times 1} & \mathbf{I}_{L-1} \end{bmatrix} 
\right) \otimes 
\begin{bmatrix} \mathbf{0}_{2 \times V} & \mathbf{I}_{2} \end{bmatrix} \quad ,
\label{eq:S3-matrix}
\end{equation}
$\mathbf{0}_{(L-1)2 \times 1}$ is an $(L-1)2 \times 1$ vector with null elements,
$\mathbf{0}_{2 \times V}$ is a $2 \times V$ matrix with null elements and 
$\mathbf{I}_{2}$ is the identity matrix of order $2$.

\subsubsection{Equality constraints}

This group if formed by two constraints that were proposed by \citet{oliveirajr-etal2011} and 
\citet{oliveirajr-barbosa2013} by following the same approach proposed \citet{barbosa-etal1997} and 
\citet{barbosa-etal1999}. They introduce a priori information about the shallowest prism and are 
suitable for outcropping sources.

The \textit{Source’s outcrop constraint} imposes that the horizontal cross-section of the shallowest prism 
must be close to the intersection of the geologic source with the known outcropping boundary. 
The matrix form of the this constraint is given by
\begin{equation}
\varphi_{4}(\mathbf{p}) = \left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right)^{\mathsf{T}} 
\left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right) ,
\end{equation}
where $\mathbf{a}$ is a vector containing the radii and the horizontal Cartesian coordinates of the 
polygon defining the outcropping boundary
\begin{equation}
\mathbf{a} = \left[ \begin{array}{@{}*{12}{c}@{}}
\tilde{r}_{1}^{0} & \dots & \tilde{r}_{V}^{0} & \tilde{x}_{0}^{0} & \tilde{y}_{0}^{0} \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:a-vector}
\end{equation}
and
\begin{equation}
\mathbf{R}_{4} = 
\begin{bmatrix}
\mathbf{I}_{V+2} & \mathbf{0}_{(V+2) \times (M-V-2)} \\
\end{bmatrix}_{(V+2)\times M},
\label{eq:R4-matrix}
\end{equation}
where $\mathbf{I}_{V+2}$ is the identity matrix of order $V+2$ and $\mathbf{0}_{(V+2) \times (M-V-2)}$ is a matrix 
with null elements.

The \textit{Source's horizontal location constraint} imposes that the horizontal Cartesian coordinates of the origin within 
the shallowest prism must be as close as possible to a known outcropping point. The matrix form of the this constraint is given by
\begin{equation}
\varphi_{5}(\mathbf{p}) = \left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b} \right)^{\mathsf{T}}
\left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b}\right) \quad ,
\end{equation}
where $\mathbf{b}$ is a vector containing the horizontal Cartesian coordinates of the outcropping point 
\begin{equation}
\mathbf{b} = \left[ \begin{array}{@{}*{12}{c}@{}}
\tilde{x}_{0}^{0} & \tilde{y}_{0}^{0} \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:b-vector}
\end{equation}
and
\begin{equation}
\mathbf{R}_{5} = 
\begin{bmatrix}
\mathbf{0}_{2 \times V} & \mathbf{I}_{2} & \mathbf{0}_{2 \times (M-V-2)} \\
\end{bmatrix}_{2 \times M},
\label{eq:R5-matrix}
\end{equation}
where $\mathbf{I}_{2}$ is the identity matrix of order $2$ and $\mathbf{0}_{2 \times (M-V-2)}$ and 
$\mathbf{0}_{2 \times V}$ are matrices with null elements.

\subsubsection{Minimum Euclidean norm constraints}

Two constraints use the zeroth-order Tikhonov regularization with the purpose of 
obtaining stable solutions without necessarily introducing significant a priori information 
about the source. 

The \textit{Minimum Euclidean norm of the radii} imposes that 
all estimated radii within each prism must be close to null values. This constraint were proposed by 
\citet{oliveirajr-etal2011} and \citet{oliveirajr-barbosa2013} and can be rewritten in matrix form 
as follows
\begin{equation}
\varphi_{6}(\mathbf{p}) = \mathbf{p}^{\mathsf{T}} \mathbf{R}_{6}^{\mathsf{T}} \mathbf{R}_{6} \mathbf{p},
\end{equation}
where
\begin{equation}
\mathbf{R}_{6} = 
\begin{bmatrix}
\mathbf{S}_{6} & \mathbf{0}_{(M-1) \times 1} \\
\mathbf{0}_{1 \times (M-1)} & 0 \\
\end{bmatrix}_{M\times M} \quad ,
\label{eq:R6-matrix}
\end{equation}
and 
\begin{equation}
\mathbf{S}_{6} = 
\begin{bmatrix}
\mathbf{I}_{V} & \mathbf{0}_{V \times 2} \\
\mathbf{0}_{2 \times V} & \mathbf{I}_{2} \\
\end{bmatrix}_{ (V+2)\times (V+2)} \quad .
\label{eq:S6-matrix}
\end{equation}

The other constraint, the \textit{Minimum Euclidean norm of the thickness}, imposes 
that the thickness of all prisms must be close to zero. This constraint were developed here 
to introduce a priori information about the maximum depth of the source. Its matrix form 
is given by
\begin{equation}
\varphi_7 = \mathbf{p}^{\mathsf{T}} \mathbf{R}_{7}^{\mathsf{T}} \mathbf{R}_{7} \mathbf{p} \quad ,
\label{eq:phi7}
\end{equation}
where
\begin{equation}
\mathbf{R}_{7} =
\begin{bmatrix}
\mathbf{0}_{(M-1) \times (M-1)} & \mathbf{0}_{(M-1) \times 1} \\
\mathbf{0}_{1 \times (M-1)} & 1 \\
\end{bmatrix}_{ M \times M } \quad .
\end{equation}