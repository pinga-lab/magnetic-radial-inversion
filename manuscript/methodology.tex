\section{Methodology}\label{sec:metodo}

\subsection{Forward problem}

Let $\mathbf{d}^{o}$ be the observed data vector, whose $i$th element $d^{o}_{i}$, $i = 1, \dots, N$, is the total-field 
anomaly produced by a 3-D source (Fig. \ref{fig:obs}a) at the point $(x_{i}, y_{i}, z_{i})$ of a Cartesian coordinate 
system with $x$, $y$ and $z$ axes pointing to north, east and down, respectively. We assume that the direction of the 
total magnetization vector of the source is constant and known. 
We approximate the volume of the source by a set of $L$ vertically juxtaposed 3-D prisms 
(Fig. \ref{fig:obs}b) by following the same approach of \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013}. 
The depth to the top of the shallowest prism is defined by $z_{0}$ and $m_{0}$ is the constant total-magnetization 
intensity of all prisms. 
The horizontal cross-section of each prism is described by a polygon with a fixed number 
$V$ of vertices equally spaced from $0^{\circ}$ to $360^{\circ}$, which are described in polar coordinates 
referred to an internal origin $O^{k}$ . 
The radii of the vertices ($r^{k}_{j}$, $j=1,\dots , V$, $k=1,\dots ,L$), the horizontal coordinates ($x_{0}^{k}$ and $y_{0}^{k}$, $k=1,\dots ,L$) 
of the origins $O^{k}$, $k=1,\dots ,L$, and the depth extent $dz$ of the $L$ vertically stacked prisms (Fig. \ref{fig:obs}b) are arranged in a 
$M \times 1$ parameter vector $\mathbf{p}$, $M = L (V + 2) + 1$, given by
\begin{equation}
\mathbf{p} = \left[ \begin{array}{@{}*{12}{c}@{}}
{\mathbf{r}^{1}}^{\mathsf{T}} & x_{0}^{1} & y_{0}^{1} & \dots & {\mathbf{r}^{L}}^{\mathsf{T}} & x_{0}^{L} & y_{0}^{L} & dz \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:p-vector}
\end{equation}
where ``$^{\mathsf{T}}$" denotes transposition and $\mathbf{r}^{k}$ is a $V \times 1$ vector containing the radii $r^{k}_{j}$ 
of the $k$th prism.
Let $\mathbf{d} (\mathbf{p})$ be the predicted data vector, whose $i$th element 
\begin{equation}
d_{i} (\mathbf{p}) \equiv \sum\limits_{k=1}^{L} f_{i}^{k}(\mathbf{r}^{k}, x_{0}^{k}, y_{0}^{k}, dz, z_{1}^{k}, m_{0}), \quad i = 1, \dots, N \: ,
\label{eq:predicted-data-i}
\end{equation}
is the total-field anomaly produced by the ensemble of $L$ prisms at the $i$th observation point ($x_{i}, y_{i}, z_{i}$). 
In eq. \ref{eq:predicted-data-i}, $f_{i}^{k}(\mathbf{r}^{k}, x_{0}^{k}, y_{0}^{k}, dz, z_{1}^{k}, m_{0})$ is the total-field anomaly 
produced, at the observation point ($x_{i}, y_{i}, z_{i}$), by the $k$th prism, with depth to the top $z_{1}^{k} = z_{0} + (k-1)dz$.
We calculate $d_{i} (\mathbf{p})$ (eq. \ref{eq:predicted-data-i}) by using the Python package Fatiando a Terra \citep{uieda-etal2013}, 
which implements the formulas proposed by \cite{plouff1976}.

\subsection{Inverse problem formulation}

Given a set of tentative values for depth to the top of the shallowest prism $z_{0}$ and for the intensity of the 
total-magnetization of the source $m_{0}$, we solve a constrained non-linear problem to estimate the parameter 
vector $\mathbf{p}$ (eq. \ref{eq:p-vector}) by minimizing the goal function
\begin{equation}
\Gamma (\mathbf{p}) = \phi (\mathbf{p}) + \sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \varphi_{\ell}(\mathbf{p}) \: ,
\label{eq:gamma}
\end{equation}
subject to
\begin{equation}
p_{l}^{min} < p_{l} < p_{l}^{max}, \quad l = 1, \dots, M \: ,
\label{eq:inequality-constraint}
\end{equation}
where $\varphi (\mathbf{p})$ is the data-misfit function given by
\begin{equation}\label{eq:misfit}
\phi (\mathbf{p}) = \frac{1}{N} \| \mathbf{d}^{o} - \mathbf{d}(\mathbf{p}) \|_{2}^{2} \: ,
\end{equation}
which represents the normalized squared Euclidean norm of the difference between the observed data vector $\mathbf{d}^{o}$ and 
the predicted data vector $\mathbf{d}(\mathbf{p})$, $\alpha_{\ell}$ is a positive number representing the weight of the 
$\ell$th constraint function $\varphi_{\ell}(\mathbf{p})$ and $p_{l}^{min}$ and $p_{l}^{max}$ are, respectively, the lower and 
upper limits for the $l$th element $p_{l}$ of the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}). 
These limits are defined by the interpreter based on both the horizontal extent of the magnetic anomaly and the knowledge 
about the source.

To solve our nonlinear inverse problem, we use a gradient-based  method and, consequently, we need to define the gradient vector 
$\boldsymbol{\nabla}\Gamma(\mathbf{p})$ and Hessian matrix $\mathbf{H}(\mathbf{p})$ of the goal function 
$\Gamma(\mathbf{p})$ (eq. \ref{eq:gamma}):
\begin{equation}\label{eq:gamma_gradient}
\boldsymbol{\nabla}\Gamma (\mathbf{p}) = \boldsymbol{\nabla}\phi (\mathbf{p}) + 
\sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \boldsymbol{\nabla}\varphi_{\ell}(\mathbf{p})
\end{equation}
and
\begin{equation}\label{eq:gamma_hessian}
\mathbf{H} (\mathbf{p}) = \mathbf{H}_\phi (\mathbf{p}) + \sum\limits^{7}_{\ell =1} \alpha_{\ell} \, \mathbf{H}_\ell \: ,
\end{equation}
where 
\begin{equation}\label{eq:phi_gradient}
\boldsymbol{\nabla} \phi(\mathbf{p}) =  - \frac{2}{N}\mathbf{G}(\mathbf{p})^{\mathsf{T}}[\mathbf{d}^o - \mathbf{d}(\mathbf{p})]
\end{equation} 
and 
\begin{equation}\label{eq:phi_hessian}
\mathbf{H}_{\phi}(\mathbf{p}) = \frac{2}{N}\mathbf{G}(\mathbf{p})^{\mathsf{T}}\mathbf{G}(\mathbf{p})
\end{equation}
are the gradient vector of the Hessian matrix of the misfit function $\phi(\mathbf{p})$ (eq. 5), respectively, the terms 
$\boldsymbol{\nabla} \varphi_{\ell}(\mathbf{p})$ and $\mathbf{H}_{\ell}$, $\ell = 1, \dots, 7$, are the gradient vectors and Hessian 
matrices of the constraint functions, respectively, and $\mathbf{G}(\mathbf{p})$ is an $N \times M$ matrix whose element $ij$ is 
the derivative of the predicted data $d_{i}(\mathbf{p})$ (eq. \ref{eq:predicted-data-i}) with respect to the $j$ element $p_{j}$ of 
the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}).
Details about the constraint functions $\varphi_\ell(\mathbf{p})$, $\ell = 1, \dots, 7$, as well as the numerical procedure to solve 
this nonlinear inverse problem are given in the following sections.


\subsection{Constraint functions}\label{sec:constraints}

We have divided the constraint functions $\varphi_{\ell}(\mathbf{p})$ (eq. \ref{eq:gamma}), $\ell = 1, \dots, 7$, used here to 
obtain stable solutions and introduce a priori information about the magnetic source into three groups.

\subsubsection{Smoothness constraints}

This group is formed by variations of the first-order Tikhonov regularization \citep[][ p. 103]{aster-etal2019}
and impose smoothness on the radii $r_{j}^{k}$ and the Cartesian coordinates $x_{0}^{k}$ and $y_{0}^{k}$ of the origin 
$O^{k}$, $j = 1, \dots, V$, $k = 1, \dots, L$, defining the horizontal section of each prism (Fig. \ref{fig:obs}b).
They were proposed by \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} and play a very 
role in introducing a prior information about the shape of the source. 

The first constraint of this group is the \textit{Smoothness constraint on the adjacent radii defining the horizontal 
section of each vertical prism}. This constraint imposes that adjacent radii $r_{j}^{k}$ and $r_{j+1}^{k}$ within each 
prism must be close to each other. It forces the estimated prism to be approximately cylindrical. Mathematically, the constraint is given by
\begin{equation}\label{eq:phi1}
\begin{split}
\varphi_{1}(\mathbf{p}) &= \sum\limits^{L}_{k=1}\left[\left(r^{k}_{V}-r^{k}_{1}\right)^2 + \sum\limits^{V-1}_{j=1}\left(r^{k}_{j}-r^{k}_{j+1}\right)^2\right]\\
 &= \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{1}\mathbf{R}_{1} \mathbf{p} \quad ,
\end{split}
\end{equation}
where
\begin{equation}
\mathbf{S}_{1} = 
\mathbf{I}_{L} \otimes 
\begin{bmatrix}
\left( \mathbf{I}_{V} - \mathbf{D}_{V}^\mathsf{T} \right) & \mathbf{0}_{V \times 2} \\
\end{bmatrix} \quad ,
\label{eq:S1-matrix}
\end{equation}
$\mathbf{0}_{LV \times 1}$ is an $LV \times 1$ vector with null elements, 
$\mathbf{I}_{L}$ is the identity matrix of order $L$, ``$\otimes$" denotes the Kronecker product 
\citep[][ p. 243]{horn_johnson1991}, $\mathbf{0}_{V \times 2}$ is a $V \times 2$ matrix with null elements, 
$\mathbf{I}_{V}$ is the identity matrix of order $V$ and $\mathbf{D}_{V}^\mathsf{T}$ is the upshift permutation 
matrix of order $V$ \citep[][ p. 20]{golub-vanloan2013}. The gradient and Hessian of function $\varphi_{1}(\mathbf{p})$ (eq. \ref{eq:phi1}) are given by:
\begin{equation}\label{eq:phi1_grad}
\boldsymbol{\nabla}\varphi_{1}(\mathbf{p}) = 2 \mathbf{R}^\mathsf{T}_{1}\mathbf{R}_{1}\mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi1_hessian}
\mathbf{H}_{1}(\mathbf{p}) = 2\mathbf{R}^\mathsf{T}_{1}\mathbf{R}_{1} \quad .
\end{equation}

The second constraint of this group is the \textit{Smoothness constraint on the adjacent radii of the 
vertically adjacent prisms}, which imposes that adjacent radii $r_{j}^{k}$ and $r_{j}^{k+1}$ within vertically 
adjacent prisms must be close to each other. This constraint forces the shape of all prisms to be similar to each other
and is given by
\begin{equation}\label{eq:phi2}
\begin{split}
\varphi_{2}(\mathbf{p}) &= \sum\limits^{L-1}_{k=1}\left[\sum\limits^{V}_{j=1}\left(r^{k+1}_{j}-r^{k}_{j}\right)^2\right] \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{2}\mathbf{R}_{2}\mathbf{p}
\end{split} \quad ,
\end{equation}
where 
\begin{equation}
\mathbf{R}_{2} = 
\begin{bmatrix}
\mathbf{S}_{2} & \mathbf{0}_{(L-1)V \times 1} \\
\end{bmatrix}_{(L-1)V \times M} \quad ,
\label{eq:R2-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{2} =
\left( 
\begin{bmatrix} \mathbf{I}_{L-1} & \mathbf{0}_{(L-1) \times 1} \end{bmatrix} -
\begin{bmatrix} \mathbf{0}_{(L-1) \times 1} & \mathbf{I}_{L-1} \end{bmatrix} 
\right) \otimes 
\begin{bmatrix} \mathbf{I}_{V} & \mathbf{0}_{V \times 2} \end{bmatrix} \quad ,
\label{eq:S2-matrix}
\end{equation}
$\mathbf{0}_{(L-1)V \times 1}$ is an $(L-1)V \times 1$ vector with null elements,
$\mathbf{0}_{(L-1) \times 1}$ is an $(L-1) \times 1$ vector with null elements and 
$\mathbf{I}_{L-1}$ is the identity matrix of order $L-1$. The gradient and Hessian of function $\varphi_{2}(\mathbf{p})$ (eq. \ref{eq:phi2}) are given by:
\begin{equation}\label{eq:phi2_grad}
\boldsymbol{\nabla}\varphi_{2}(\mathbf{p}) = 2\mathbf{R}^\mathsf{T}_{2}\mathbf{R}_{2}\mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi2_hessian}
\mathbf{H}_{2}(\mathbf{p}) = 2\mathbf{R}^\mathsf{T}_{2}\mathbf{R}_{2} \quad .
\end{equation}

The last constraint of this group is the \textit{Smoothness constraint on the horizontal position of 
the arbitrary origins of the vertically adjacent prisms}. This constraint imposes that the estimated horizontal 
Cartesian coordinates $(x_{0}^{k}, y_{0}^{k})$ and $(x_{0}^{k+1}, y_{0}^{k+1})$ of the origins $O^{k}$ and $O^{k+1}$ 
of adjacent prisms must be close to each other. It forces the prisms to be vertically aligned. This constraint 
is given by
\begin{equation}\label{eq:phi3}
\begin{split}
\varphi_{3}(\mathbf{p}) &= \sum\limits^{L-1}_{k=1}\left[\left(x_{0}^{k+1} - x_{0}^{k}\right)^2 + \left(y_{0}^{k+1} - y_{0}^{k}\right)^2 \right] \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3}\mathbf{p}
\end{split} \quad ,
\end{equation}
where 
\begin{equation}
\mathbf{R}_{3} = 
\begin{bmatrix}
\mathbf{S}_{3} & \mathbf{0}_{(L-1)2 \times 1} \\
\end{bmatrix}_{(L-1)2 \times M} \quad ,
\label{eq:R3-matrix}
\end{equation}
\begin{equation}
\mathbf{S}_{3} =
\left( 
\begin{bmatrix} \mathbf{I}_{L-1} & \mathbf{0}_{(L-1) \times 1} \end{bmatrix} -
\begin{bmatrix} \mathbf{0}_{(L-1) \times 1} & \mathbf{I}_{L-1} \end{bmatrix} 
\right) \otimes 
\begin{bmatrix} \mathbf{0}_{2 \times V} & \mathbf{I}_{2} \end{bmatrix} \quad ,
\label{eq:S3-matrix}
\end{equation}
$\mathbf{0}_{(L-1)2 \times 1}$ is an $(L-1)2 \times 1$ vector with null elements,
$\mathbf{0}_{2 \times V}$ is a $2 \times V$ matrix with null elements and 
$\mathbf{I}_{2}$ is the identity matrix of order $2$. The gradient and Hessian of function $\varphi_{3}(\mathbf{p})$ (eq. \ref{eq:phi3}) are given by:
\begin{equation}\label{eq:phi3_grad}
\boldsymbol{\nabla}\varphi_{3}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3}\mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi3_hessian}
\mathbf{H}_{3}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{3}\mathbf{R}_{3} \quad .
\end{equation}

\subsubsection{Equality constraints}

This group if formed by two constraints that were proposed by \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} by following the same approach proposed \cite{barbosa-etal1997} and 
\cite{barbosa-etal1999}. They introduce a priori information about the shallowest prism and are  suitable for outcropping sources.

The \textit{Source’s outcrop constraint} imposes that the horizontal cross-section of the shallowest prism 
must be close to the intersection of the geologic source with the known outcropping boundary. 
The matrix form of the this constraint is given by
\begin{equation}\label{eq:phi4}
\begin{split}
\varphi_{4}(\mathbf{p}) &= \left[\left(x_{0}^{1} - x_{0}^{0}\right)^2 + \left(y_{0}^{1} - y_{0}^{0}\right)^2 + \sum\limits^{V}_{j=1}\left(r^{1}_{j}-r^{0}_{j}\right)^2\right] \\
&= \left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right)^{\mathsf{T}} 
\left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right)
\end{split} \quad ,
\end{equation}
where $\mathbf{a}$ is a vector containing the radii and the horizontal Cartesian coordinates of the 
polygon defining the outcropping boundary
\begin{equation}
\mathbf{a} = \left[ \begin{array}{@{}*{12}{c}@{}}
\tilde{r}_{1}^{0} & \dots & \tilde{r}_{V}^{0} & \tilde{x}_{0}^{0} & \tilde{y}_{0}^{0} \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:a-vector}
\end{equation}
and
\begin{equation}
\mathbf{R}_{4} = 
\begin{bmatrix}
\mathbf{I}_{V+2} & \mathbf{0}_{(V+2) \times (M-V-2)} \\
\end{bmatrix}_{(V+2)\times M},
\label{eq:R4-matrix}
\end{equation}
where $\mathbf{I}_{V+2}$ is the identity matrix of order $V+2$ and $\mathbf{0}_{(V+2) \times (M-V-2)}$ is a matrix 
with null elements. The gradient and Hessian of function $\varphi_{4}(\mathbf{p})$ (eq. \ref{eq:phi4}) are given by:
\begin{equation}\label{eq:phi4_grad}
\boldsymbol{\nabla}\varphi_{4}(\mathbf{p}) = 2 \mathbf{R}_{4}^{\mathsf{T}} 
\left(\mathbf{R}_{4} \mathbf{p} - \mathbf{a} \right) \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi4_hessian}
\mathbf{H}_{4}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{4}\mathbf{R}_{4} \quad .
\end{equation}

The \textit{Source's horizontal location constraint} imposes that the horizontal Cartesian coordinates of the origin within 
the shallowest prism must be as close as possible to a known outcropping point. The matrix form of the this constraint is given by
\begin{equation}\label{eq:phi5}
\begin{split}
\varphi_{5}(\mathbf{p}) &= \left[\left(x_{0}^{1} - x_{0}^{0}\right)^2 + \left(y_{0}^{1} - y_0^0\right)^2\right] \\
&= \left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b} \right)^{\mathsf{T}}
\left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b}\right)
\end{split} \quad ,
\end{equation}
where $\mathbf{b}$ is a vector containing the horizontal Cartesian coordinates of the outcropping point 
\begin{equation}
\mathbf{b} = \left[ \begin{array}{@{}*{12}{c}@{}}
\tilde{x}_{0}^{0} & \tilde{y}_{0}^{0} \\
\end{array} \right]^{\mathsf{T}} \: ,
\label{eq:b-vector}
\end{equation}
and
\begin{equation}
\mathbf{R}_{5} = 
\begin{bmatrix}
\mathbf{0}_{2 \times V} & \mathbf{I}_{2} & \mathbf{0}_{2 \times (M-V-2)} \\
\end{bmatrix}_{2 \times M},
\label{eq:R5-matrix}
\end{equation}
where $\mathbf{I}_{2}$ is the identity matrix of order $2$ and $\mathbf{0}_{2 \times (M-V-2)}$ and 
$\mathbf{0}_{2 \times V}$ are matrices with null elements. The gradient and Hessian of function $\varphi_{5}(\mathbf{p})$ (eq. \ref{eq:phi5}) are given by:
\begin{equation}\label{eq:phi5_grad}
\boldsymbol{\nabla}\varphi_{5}(\mathbf{p}) = 2\mathbf{R}_{5}^{\mathsf{T}}
\left(\mathbf{R}_{5} \mathbf{p} - \mathbf{b}\right) \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi5_hessian}
\mathbf{H}_{5}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{5}\mathbf{R}_{5} \quad .
\end{equation}

\subsubsection{Minimum Euclidean norm constraints}

Two constraints use the zeroth-order Tikhonov regularization with the purpose of obtaining stable solutions without necessarily introducing significant a priori information about the source. 

The \textit{Minimum Euclidean norm of the radii} imposes that 
all estimated radii within each prism must be close to null values. This constraint were proposed by \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} and can be rewritten in matrix form as follows
\begin{equation}\label{eq:phi6}
\begin{split}
\varphi_{6}(\mathbf{p}) &= \sum\limits^{L}_{k=1}\sum\limits^{V}_{j=1}\left(r_{j}^{k}\right)^2 \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}_{6}^{\mathsf{T}} \mathbf{R}_{6} \mathbf{p}
\end{split} \quad ,
\end{equation}
where
\begin{equation}
\mathbf{R}_{6} = 
\begin{bmatrix}
\mathbf{S}_{6} & \mathbf{0}_{(M-1) \times 1} \\
\mathbf{0}_{1 \times (M-1)} & 0 \\
\end{bmatrix}_{M\times M} \quad ,
\label{eq:R6-matrix}
\end{equation}
and 
\begin{equation}
\mathbf{S}_{6} = 
\begin{bmatrix}
\mathbf{I}_{V} & \mathbf{0}_{V \times 2} \\
\mathbf{0}_{2 \times V} & \mathbf{I}_{2} \\
\end{bmatrix}_{ (V+2)\times (V+2)} \quad .
\label{eq:S6-matrix}
\end{equation}
The gradient and Hessian of function $\varphi_{6}(\mathbf{p})$ (eq. \ref{eq:phi6}) are given by:
\begin{equation}\label{eq:phi6_grad}
\boldsymbol{\nabla}\varphi_{6}(\mathbf{p}) = 2 \mathbf{R}_{6}^{\mathsf{T}} \mathbf{R}_{6} \mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi6_hessian}
\mathbf{H}_{6}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{6}\mathbf{R}_{6} \quad .
\end{equation}

The other constraint, the \textit{Minimum Euclidean norm of the depth extent}, imposes that the depth extent of all prisms must be close to zero. We present this constraint to introduce a priori information about the maximum depth of the source. It is given by
\begin{equation}\label{eq:phi7}
\begin{split}
\varphi_{7}(\mathbf{p}) &= dz^2 \\
&= \mathbf{p}^{\mathsf{T}} \mathbf{R}_{7}^{\mathsf{T}} \mathbf{R}_{7} \mathbf{p}
\end{split} \quad ,
\end{equation}
where
\begin{equation}
\mathbf{R}_{7} =
\begin{bmatrix}
\mathbf{0}_{(M-1) \times (M-1)} & \mathbf{0}_{(M-1) \times 1} \\
\mathbf{0}_{1 \times (M-1)} & 1 \\
\end{bmatrix}_{ M \times M } \quad .
\end{equation}
The gradient and Hessian of function $\varphi_{7}(\mathbf{p})$ (eq. \ref{eq:phi7}) are given by:
\begin{equation}\label{eq:phi7_grad}
\boldsymbol{\nabla}\varphi_{7}(\mathbf{p}) = 2 \mathbf{R}_{7}^{\mathsf{T}} \mathbf{R}_{7} \mathbf{p} \quad ,
\end{equation}
and
\begin{equation}\label{eq:phi7_hessian}
\mathbf{H}_{7}(\mathbf{p}) = 2 \mathbf{R}^{\mathsf{T}}_{7}\mathbf{R}_{7} \quad .
\end{equation}

\subsection{Computational procedures}

To estimate the parameter vector $\mathbf{p}$ (eq. \ref{eq:p-vector}) that minimizes the goal function 
$\Gamma(\mathbf{p})$ (eq. \ref{eq:gamma}), subjected to the inequality constraint (eq. \ref{eq:inequality-constraint}), 
we use the Levenberg-Marquardt method \cite[e.g., ][ p. 240]{aster-etal2019}. 
This is an iterative gradient-based method that, at each iteration $k$, updates the estimated 
parameter vector $\hat{\mathbf{p}}_{(k)}$ (where the superscript hat ``~$\hat{}$~" denotes estimated) 
to obtain new a estimated parameter vector $\hat{\mathbf{p}}_{(k+1)}$.
We compute this update by following the same strategy 
of \cite{barbosa-1999b}, \cite{oliveirajr-etal2011} and \cite{oliveirajr-barbosa2013} to
incorporate the inequality constraint (eq. \ref{eq:inequality-constraint}). 
This strategy consists in transforming each element $p_{l}$ of the estimated parameter vector 
$\hat{\mathbf{p}}_{(k)}$ into the element $p^{\dagger}_{l}$ of a new vector $\hat{\mathbf{p}}^{\dagger}_{(k)}$
as follows:
\begin{equation}\label{eq:inequality-function}
p^{\dagger}_{l} = -\ln\left(\frac{p_{l}^{max} - p_{l}}{p_{l} - p_{l}^{min}}\right) \: ,
\end{equation}
where $p_{l}^{min}$ and $p_{l}^{max}$ are defined in the inequality constraint 
(eq. \ref{eq:inequality-constraint}).
Then, we compute a correction $\boldsymbol{\Delta}\hat{\mathbf{p}}^{\dagger}_{(k)}$ and a new vector 
$\hat{\mathbf{p}}^{\dagger}_{(k+1)} = \hat{\mathbf{p}}^{\dagger}_{(k)} + \boldsymbol{\Delta}\hat{\mathbf{p}}^{\dagger}_{(k)}$.
Finally, we transform each element $p^{\dagger}_{l}$ of $\hat{\mathbf{p}}^{\dagger}_{(k+1)}$ into the element 
$p_{l}$ of the new estimated parameter vector $\hat{\mathbf{p}}_{(k+1)}$ as follows:
\begin{equation}\label{eq:inv-inequality-function}
p_{l} = p_{l}^{min} + \left(\frac{p_{l}^{max} - p_{l}^{min}}{ 1 + e^{-p^{\dagger}_{l}} }\right) \: .
\end{equation}
What follows presents details about how we compute the correction 
$\boldsymbol{\Delta}\hat{\mathbf{p}}^{\dagger}_{(k)}$ and a fully description of our algorithm.

\subsubsection{Considerations about the weights $\alpha_{1}-\alpha_{7}$}

Attributing values to the weights $ \alpha_{\ell} $ (eq. \ref{eq:gamma}) is an important feature of our method. 
However, there is no analytical rule to define them and their values can be dependent on the particular 
characteristics of the interpretation model. To overcome this problem, we normalize the $ \alpha_{\ell} $ 
values as follows:
\begin{equation}\label{eq:alphas}
\alpha_{\ell} = \tilde{\alpha}_\ell\frac{E_\phi}{E_\ell}, \quad \ell = 1,\dots, 7,
\end{equation}
where $\tilde{\alpha}_\ell$ is a positive scalar and $ E_\phi/E_\ell $ is a normalizing factor. 
In this equation, $ E_\ell $ represents the 
trace of the Hessian matrix $\mathbf{H}_{\ell}$ 
(eqs \ref{eq:phi1_hessian}, \ref{eq:phi2_hessian}, \ref{eq:phi3_hessian}, \ref{eq:phi4_hessian}, \ref{eq:phi5_hessian}, 
\ref{eq:phi6_hessian}, and \ref{eq:phi7_hessian})
of the $\ell$th constraining function $\varphi_{\ell}(\mathbf{p})$ 
(eqs \ref{eq:phi1}, \ref{eq:phi2}, \ref{eq:phi3}, \ref{eq:phi4}, \ref{eq:phi5}, \ref{eq:phi6}, and \ref{eq:phi7}). 
The constant $E_\phi$ is the trace of the Hessian matrix $\mathbf{H}_{\phi}(\mathbf{p}_{0})$ (eq. \ref{eq:phi_hessian}) of 
the misfit function $\phi(\mathbf{p})$ (eq. \ref{eq:misfit}) computed with the initial approximation $\hat{\mathbf{p}}_{(0)}$ 
for the parameter vector $ \mathbf{p} $ (eq. \ref{eq:p-vector}) at the beginning of the inversion algorithm. 
According to this empirical strategy, the weights $ \alpha_{\ell} $ 
are defined using the positive scalars $\tilde{\alpha}_\ell$ (eq. \ref{eq:alphas}), which are less dependent on the 
particular characteristics of the interpretation model.

\subsubsection{Inversion algorithm}

At each iteration $k$ of our algorithm, the correction $\boldsymbol{\Delta}\hat{\mathbf{p}}^{\dagger}_{(k)}$
is computed by solving the following linear system:
\begin{equation}\label{eq:linear-system}
\mathbf{D}_{(k)} \left[\mathbf{D}_{(k)} \mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(k)}) \mathbf{D}_{(k)} + \lambda_{(k)} \mathbf{I}\right] \mathbf{D}_{(k)} \boldsymbol{\Delta} \hat{\mathbf{p}}^{\dagger}_{(k)} = -\boldsymbol{\nabla}\Gamma(\hat{\mathbf{p}}_{(k)}) \: ,
\end{equation}
where $\lambda_{(k)}$ is the a positive scalar adjusted at each iteration \cite[e.g., ][ p. 240]{aster-etal2019}, 
$\mathbf{I}$ is the identity matrix with order $M$, $\boldsymbol{\nabla}\Gamma(\hat{\mathbf{p}})$ is the gradient of the 
goal function (eq. \ref{eq:gamma_gradient}) and $\mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(k)})$ is a matrix given by
\begin{equation}\label{eq:H-dagger}
\mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(k)}) = \mathbf{H}(\hat{\mathbf{p}}_{(k)})\mathbf{T}(\hat{\mathbf{p}}_{(k)}),
\end{equation}
where $\mathbf{H}(\hat{\mathbf{p}}_{(k)})$ is the Hessian matrix of the goal function (eq. \ref{eq:gamma_hessian}) 
and $\mathbf{T}(\hat{\mathbf{p}}_{(k)})$ is a diagonal matrix whose element $ll$ is given by
\begin{equation}\label{eq:inequality-diag}
t(p_{l}) = \frac{(p_{l}^{max} - p_{l})(p_{l} - p_{l}^{min})}{p_{l}^{max} - p_{l}^{min}}, \quad l = 1, \dots, M \: ,
\end{equation}
with $p_{l}$ being the $l$th element of the estimated parameter vector $\hat{\mathbf{p}}_{(k)}$. 
In eq. \ref{eq:linear-system}, $\mathbf{D}_{(k)}$ is a diagonal matrix proposed by 
\cite{marquardt_algorithm_1963} for scaling the parameter $\lambda_{(k)}$ at each iteration and 
improving the convergence of the algorithm. The element $ll$ of this diagonal matrix is given by
\begin{equation}\label{eq:D-matrix}
d_{ll} = \frac{1}{\sqrt{h^{\dagger}_{ll}}} \: ,
\end{equation}
where $h^{\dagger}_{ll}$ is the element $ll$ of the matrix $\mathbf{H}^{\dagger}(\hat{\mathbf{p}}_{(k)})$ 
(eq. \ref{eq:H-dagger}). Figure \ref{fig:flowchart} shows a flowchart of our algorithm.

PAREI AQUI

\subsubsection{Practical considerations}

Our algorithm depends on several parameters that significantly impact the estimated models and cannot be automatically set without the interpreter’s judgment. They are the parameters $\tilde{\alpha}_1$, $\tilde{\alpha}_2$, $\tilde{\alpha}_3$, $\tilde{\alpha}_4$, $\tilde{\alpha}_5$, $\tilde{\alpha}_6$, and $\tilde{\alpha}_7$. Based on our practical experience, we suggest some empirical procedures for setting these parameters.

The parameters $\tilde{\alpha}_1$ and $\tilde{\alpha}_2$ impose priori information on the shape of the horizontal cross-section of the prisms. Generally, they have values close to each other varying from $10^{-5}$ to $10^{-4}$. If $\tilde{\alpha}_1 > \tilde{\alpha}_2$ the prisms will have a very smooth horizontal cross-section, close to a circular shape. On the other hand, if $\tilde{\alpha}_1 < \tilde{\alpha}_2$, than the difference on the shape of the horizontal cross-sections of the estimated model between vertically adjacent prisms will be smooth.

To control the alignment of the estimated model, the parameter $\tilde{\alpha}_3$ should be in a range from $10^{-5}$ to $10^{-3}$. This parameter allows or forbids the estimated model to dip. Empirically, the value for this parameter follows the value for $\tilde{\alpha}_1$ and $\tilde{\alpha}_2$, they are usually close.

The parameter $\tilde{\alpha}_6$ imposes mathematical priori information on the inverse problem to control the convergence of the algorithm. We suggest that the value for this parameter should be two or three orders of magnitude greater than $\tilde{\alpha}_1$ and $\tilde{\alpha}_2$.

To control the depth extent of the estimated model, the parameter $\tilde{\alpha}_7$ should be in a range from $10^{-6}$ to $10^{-4}$. This parameter depends on the depth extent of the initial approximate, it can decrease the depth extent or keep it close to the initial one. Normally, we suggest $\tilde{\alpha}_7=10^{-5}$ for a initial value.

An important aspect of our method is the choice of the initial approximation. For simplicity, we use a cylinder shape as an initial approximation located the initial cylinder on the center of the anomaly. We suggest that the cylinder radius should involves a great part, both positive and negative, of the horizontal size of the anomaly. Also, the depth extent $dz$ of the cylinder should be greater than the true source. We suggest that the data produced by the initial approximation fit qualitatively the observations.